<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ è¶…å¼·åŒ–ç‰ˆç¦æ¬²ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ğŸ”¥</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ddd;
            overflow-y: auto;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1em;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            text-align: center;
            position: relative;
            margin-bottom: 2em;
        }

        .header h1 {
            font-size: 2.5em;
            margin: 0.5em 0;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.3)); }
            to { filter: drop-shadow(0 0 20px rgba(255, 107, 107, 0.6)); }
        }

        /* ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ« */
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 0.5em 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5em;
            margin: 1em 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
        }

        /* ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ  */
        .level-section {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .level-display {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }

        .xp-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 1em 0;
        }

        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, #feca57, #ff9ff3);
            border-radius: 10px;
            transition: width 1s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1em;
            margin: 1em 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 1.5em;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 0.5em;
        }

        /* å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ  */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1em;
            margin: 1em 0;
        }

        .achievement {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1em;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .achievement-icon {
            font-size: 2em;
            margin-bottom: 0.5em;
        }

        .achievement-title {
            font-size: 0.8em;
            font-weight: bold;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 0.8em 1.5em;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 0.3em;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            font-size: 1.2em;
            padding: 1em 2em;
        }

        /* æ—¥è¨˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .journal-entry {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1em;
            color: #ddd;
            font-family: inherit;
            resize: vertical;
        }

        /* ç·Šæ€¥ã‚µãƒãƒ¼ãƒˆ */
        .emergency-section {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            text-align: center;
            animation: emergencyPulse 2s ease-in-out infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .emergency-section.hidden {
            display: none;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å¼·åŒ– */
        .calendar {
            background: rgba(255, 255, 255, 0.03);
        }

        .calendar table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .calendar th,
        .calendar td {
            padding: 1em;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .calendar td:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .calendar .achieved {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            font-weight: bold;
        }

        .calendar .today {
            border: 3px solid #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }

        /* åè¨€è¡¨ç¤º */
        .quote-section {
            background: linear-gradient(135deg, #5f27cd, #341f97);
            text-align: center;
            font-style: italic;
            position: relative;
        }

        .quote-text {
            font-size: 1.2em;
            margin-bottom: 0.5em;
        }

        .quote-author {
            opacity: 0.8;
            font-size: 0.9em;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆ */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1em 0;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .stats-grid { grid-template-columns: 1fr; }
            .achievements-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .theme-toggle { position: relative; margin: 1em 0; }
        }

        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
        body.light-mode {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #333;
        }

        body.light-mode .card {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode .xp-bar {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .xp-progress {
            background: linear-gradient(90deg, #feca57, #ff9ff3); /* åŒã˜ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒ */
        }

        body.light-mode .calendar th,
        body.light-mode .calendar td {
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .calendar td:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .journal-entry,
        body.light-mode #addActivityInput {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode #activitiesList div {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode .chart-container canvas {
            background-color: rgba(255, 255, 255, 0.8); /* ãƒãƒ£ãƒ¼ãƒˆèƒŒæ™¯ã‚‚æ˜ã‚‹ã */
            border-radius: 15px;
        }

        /* ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ  */
        .tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2em;
            overflow-x: auto;
        }

        body.light-mode .tabs {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 1em 2em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        body.light-mode .tab.active {
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #2a2a4a;
            border-radius: 15px;
            padding: 2em;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #ddd;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #feca57;
        }

        .modal-content p {
            margin-bottom: 1.5em;
        }

        .modal-buttons button {
            margin: 0 0.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ”¥ è¶…å¼·åŒ–ç‰ˆç¦æ¬²ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ğŸ”¥</h1>
            <button class="theme-toggle" id="themeToggle">ğŸŒ“ ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
        </div>

        <!-- ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ  -->
        <div class="card level-section">
            <div class="level-display">ãƒ¬ãƒ™ãƒ« <span id="userLevel">1</span></div>
            <div>çµŒé¨“å€¤: <span id="currentXP">0</span> / <span id="maxXP">100</span></div>
            <div class="xp-bar">
                <div class="xp-progress" id="xpProgress"></div>
            </div>
            <div id="levelTitle">åˆå¿ƒè€…</div>
        </div>

        <!-- ä»Šæ—¥ã®åè¨€ -->
        <div class="card quote-section" id="quoteSection">
            <div class="quote-text" id="quoteText"></div>
            <div class="quote-author" id="quoteAuthor"></div>
        </div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
            <div class="tab" data-tab="calendar">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
            <div class="tab" data-tab="achievements">ğŸ† å®Ÿç¸¾</div>
            <div class="tab" data-tab="journal">ğŸ“” æ—¥è¨˜</div>
            <div class="tab" data-tab="activities">ğŸ’¡ ä»£æ›¿æ´»å‹•</div>
            <div class="tab" data-tab="analytics">ğŸ“ˆ åˆ†æ</div>
            <div class="tab" data-tab="settings">âš™ï¸ è¨­å®š</div>
        </div>

        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="longestStreak">0</div>
                    <div class="stat-label">æœ€é•·è¨˜éŒ²</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDays">0</div>
                    <div class="stat-label">ç·æˆåŠŸæ—¥æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0</div>
                    <div class="stat-label">æˆåŠŸç‡ (%)</div>
                </div>
            </div>

            <div style="text-align: center; margin: 2em 0;">
                <button class="btn primary" id="markSuccessBtn">âœ… ä»Šæ—¥é”æˆï¼</button>
                <button class="btn" id="emergencyBtn">ğŸš¨ ç·Šæ€¥ã‚µãƒãƒ¼ãƒˆ</button>
            </div>

            <div class="card emergency-section hidden" id="emergencySection">
                <h2>ğŸš¨ ç·Šæ€¥ã‚µãƒãƒ¼ãƒˆ ğŸš¨</h2>
                <p>æ·±å‘¼å¸ã—ã¦ã€ãªãœã“ã“ã¾ã§é ‘å¼µã£ã¦ããŸã®ã‹æ€ã„å‡ºã—ã¦ãã ã•ã„ã€‚</p>
                <button class="btn" id="breathingBtn">ğŸ« æ·±å‘¼å¸ã‚¬ã‚¤ãƒ‰</button>
                <button class="btn" id="motivationBtn">ğŸ’ª ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è£œçµ¦</button>
                <button class="btn" id="distractionBtn">ğŸ¯ æ°—åˆ†è»¢æ›</button>
            </div>

            <div id="congratsMessage" class="card" style="display: none; background: linear-gradient(135deg, #00b894, #55a3ff); text-align: center;"></div>
        </div>

        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ– -->
        <div class="tab-content" id="calendar">
            <div class="card calendar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                    <button class="btn" id="prevMonth">â† å‰æœˆ</button>
                    <h2 id="monthYear"></h2>
                    <button class="btn" id="nextMonth">æ¬¡æœˆ â†’</button>
                </div>
                <table id="calendarTable"></table>
            </div>
        </div>

        <!-- å®Ÿç¸¾ã‚¿ãƒ– -->
        <div class="tab-content" id="achievements">
            <div class="card">
                <h2>ğŸ† å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ </h2>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
        </div>

        <!-- æ—¥è¨˜ã‚¿ãƒ– -->
        <div class="tab-content" id="journal">
            <div class="card">
                <h2>ğŸ“” ä»Šæ—¥ã®æ—¥è¨˜</h2>
                <textarea class="journal-entry" id="journalEntry" placeholder="ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿæ„Ÿã˜ãŸã“ã¨ã‚„å­¦ã‚“ã ã“ã¨ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„..."></textarea>
                <div style="text-align: center; margin-top: 1em;">
                    <button class="btn" id="saveJournalBtn">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“š éå»ã®æ—¥è¨˜</h3>
                <div id="journalHistory"></div>
            </div>
        </div>

        <!-- ä»£æ›¿æ´»å‹•ã‚¿ãƒ– -->
        <div class="tab-content" id="activities">
            <div class="card">
                <h2>ğŸ’¡ ä»£ã‚ã‚Šã«ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</h2>
                <div style="margin: 1em 0;">
                    <input type="text" id="addActivityInput" placeholder="æ–°ã—ã„æ´»å‹•ã‚’è¿½åŠ ..." 
                            style="width: 70%; padding: 0.8em; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ddd;">
                    <button class="btn" id="addActivityBtn">â• è¿½åŠ </button>
                </div>
                <div id="activitiesList"></div>
            </div>
        </div>

        <!-- åˆ†æã‚¿ãƒ– -->
        <div class="tab-content" id="analytics">
            <div class="card">
                <h2>ğŸ“ˆ æˆåŠŸç‡åˆ†æ</h2>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ“Š æ›œæ—¥åˆ¥æˆåŠŸç‡</h2>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div class="tab-content" id="settings">
            <div class="card">
                <h2>âš™ï¸ è¨­å®š</h2>
                <div style="margin: 1em 0;">
                    <label>
                        <input type="checkbox" id="enableNotifications"> é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    </label>
                </div>
                <div style="margin: 1em 0;">
                    <label>
                        ç›®æ¨™æ—¥æ•°: <input type="number" id="goalDays" value="30" min="1" style="width: 80px; padding: 0.5em; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ddd;">
                    </label>
                </div>
                <div style="text-align: center; margin-top: 2em;">
                    <button class="btn" id="exportBtn">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn" id="importBtn">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <button class="btn" id="resetBtn" style="background: linear-gradient(135deg, #ff4757, #ff3838);">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".json" style="display:none;">

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´  -->
    <div class="modal-overlay" id="customModal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons" id="modalButtons">
                <!-- ãƒœã‚¿ãƒ³ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
            </div>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let appData = {
            achievedDates: [],
            totalXP: 0,
            level: 1,
            journal: {},
            activities: [
                '30åˆ†é‹å‹•ã™ã‚‹', 'æœ¬ã‚’20ãƒšãƒ¼ã‚¸èª­ã‚€', 'ç‘æƒ³ã™ã‚‹', 'æ•£æ­©ã«å‡ºã‚‹', 'å‹é”ã«é€£çµ¡',
                'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªä½œæ¥­', 'éƒ¨å±‹ã‚’æ•´ç†', 'æ–°ã—ã„ã‚¹ã‚­ãƒ«å­¦ç¿’', 'æ–™ç†ã‚’ã™ã‚‹', 'éŸ³æ¥½ã‚’è´ã'
            ],
            theme: 'dark',
            goalDays: 30,
            notifications: false,
            streakProtections: 3, // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ä¿è­·æ©Ÿèƒ½ã®è¿½åŠ 
            unlockedAchievements: [] // å®Ÿç¸¾ã®ãƒ­ãƒƒã‚¯è§£é™¤çŠ¶æ…‹ã‚’è¿½è·¡
        };

        // åè¨€é›†
        const quotes = [
            { text: "æˆåŠŸã¯æº–å‚™ã¨æ©Ÿä¼šãŒå‡ºä¼šã†ã¨ã“ã‚ã«ç”Ÿã¾ã‚Œã‚‹", author: "ã‚»ãƒã‚«" },
            { text: "è‡ªåˆ¶å¿ƒã¯ç­‹è‚‰ã®ã‚ˆã†ãªã‚‚ã®ã€‚ä½¿ãˆã°ä½¿ã†ã»ã©å¼·ããªã‚‹", author: "ä¸æ˜" },
            { text: "æ„å¿—ã®åŠ›ã¯ã€ç¹°ã‚Šè¿”ã—ã®åŠ›ã§ã‚ã‚‹", author: "ä¸æ˜" },
            { text: "ä»Šæ—¥ã®è‡ªåˆ†ã¯ã€æ˜¨æ—¥ã®é¸æŠã®çµæœã§ã‚ã‚‹", author: "ä¸æ˜" },
            { text: "å°ã•ãªä¸€æ­©ã§ã‚‚ã€æ­£ã—ã„æ–¹å‘ã¸ã®ä¸€æ­©ã§ã‚ã‚‹", author: "ä¸æ˜" },
            { text: "å¤‰åŒ–ã¯æ±ºæ–­ã‹ã‚‰å§‹ã¾ã‚‹", author: "ãƒˆãƒ‹ãƒ¼ãƒ»ãƒ­ãƒ“ãƒ³ã‚º" },
            { text: "å›°é›£ã¯æˆé•·ã®æ©Ÿä¼šã§ã‚ã‚‹", author: "ä¸æ˜" },
            { text: "ç¶™ç¶šã¯åŠ›ãªã‚Š", author: "æ—¥æœ¬ã®ã“ã¨ã‚ã–" }
        ];

        // å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ 
        const achievements = [
            { id: 'first_day', icon: 'ğŸŒ±', title: 'ç¬¬ä¸€æ­©', desc: '1æ—¥é”æˆ', days: 1 },
            { id: 'week_warrior', icon: 'âš¡', title: 'é€±ã®æˆ¦å£«', desc: '7æ—¥é”æˆ', days: 7 },
            { id: 'month_master', icon: 'ğŸ…', title: 'æœˆã®é”äºº', desc: '30æ—¥é”æˆ', days: 30 },
            { id: 'legend', icon: 'ğŸ‘‘', title: 'ä¼èª¬', desc: '100æ—¥é”æˆ', days: 100 },
            { id: 'godlike', icon: 'ğŸ†', title: 'ç¥ã®åŸŸ', desc: '365æ—¥é”æˆ', days: 365 },
            { id: 'perfect_week', icon: 'ğŸ’', title: 'å®Œç’§ãªé€±', desc: 'é€±7æ—¥é€£ç¶š', special: 'perfect_week' },
            { id: 'comeback_king', icon: 'ğŸ”„', title: 'å¾©æ´»ç‹', desc: 'å¤±æ•—å¾Œå¾©æ´»', special: 'comeback' },
            { id: 'journal_keeper', icon: 'âœï¸', title: 'æ—¥è¨˜ã®é”äºº', desc: 'æ—¥è¨˜ã‚’10å›è¨˜éŒ²', special: 'journal_count', count: 10 },
            { id: 'activity_master', icon: 'ğŸƒ', title: 'æ´»å‹•ã®é”äºº', desc: 'ä»£æ›¿æ´»å‹•ã‚’5ã¤è¿½åŠ ', special: 'activity_count', count: 5 }
        ];

        // ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
        const levels = [
            { level: 1, xp: 0, title: 'åˆå¿ƒè€…' },
            { level: 2, xp: 100, title: 'æŒ‘æˆ¦è€…' },
            { level: 3, xp: 300, title: 'æˆ¦å£«' },
            { level: 4, xp: 600, title: 'é”äºº' },
            { level: 5, xp: 1000, title: 'ãƒã‚¹ã‚¿ãƒ¼' },
            { level: 6, xp: 1500, title: 'ä¼èª¬' },
            { level: 7, xp: 2100, title: 'ç¥è©±' },
            { level: 8, xp: 2800, title: 'ä¸æ­»èº«' },
            { level: 9, xp: 3600, title: 'è¶…è¶Šè€…' },
            { level: 10, xp: 4500, title: 'å®Œå…¨ä½“' }
        ];

        // ç¾åœ¨ã®è¡¨ç¤ºæœˆ
        let viewYear, viewMonth;
        let charts = {};

        // åˆæœŸåŒ–
        function init() {
            loadData();
            setupEventListeners();
            setupTabs();
            updateAll();
            showDailyQuote();
            
            const today = new Date();
            viewYear = today.getFullYear();
            viewMonth = today.getMonth();
            
            renderCalendar();
            initCharts();
            applyTheme();

            // ç›®æ¨™æ—¥æ•°ã‚’è¨­å®šã«åæ˜ 
            document.getElementById('goalDays').value = appData.goalDays;
            document.getElementById('enableNotifications').checked = appData.notifications;

            // é€šçŸ¥æ¨©é™ã®ç¢ºèª
            if (appData.notifications && Notification.permission !== "granted") {
                requestNotificationPermission();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿é–¢é€£
        function loadData() {
            const saved = localStorage.getItem('enhancedAbstinenceData');
            if (saved) {
                try {
                    // ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãƒãƒ¼ã‚¸ã—ã¦ã€æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¿½åŠ ã•ã‚Œã¦ã‚‚å£Šã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
                    const loadedData = JSON.parse(saved);
                    appData = { ...appData, ...loadedData };
                    // achievedDatesã¯æ—¥ä»˜æ–‡å­—åˆ—ã®é…åˆ—ãªã®ã§ã€ã‚½ãƒ¼ãƒˆã—ã¦ãŠã
                    appData.achievedDates.sort((a, b) => new Date(a) - new Date(b));
                } catch(e) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                }
            }
        }

        function saveData() {
            localStorage.setItem('enhancedAbstinenceData', JSON.stringify(appData));
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('markSuccessBtn').addEventListener('click', markTodaySuccess);
            document.getElementById('emergencyBtn').addEventListener('click', toggleEmergencySection);
            document.getElementById('breathingBtn').addEventListener('click', startBreathingGuide);
            document.getElementById('motivationBtn').addEventListener('click', showMotivation);
            document.getElementById('distractionBtn').addEventListener('click', suggestDistraction);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('addActivityBtn').addEventListener('click', addActivity);
            document.getElementById('saveJournalBtn').addEventListener('click', saveJournal);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importInput').click());
            document.getElementById('importInput').addEventListener('change', importData);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            
            // è¨­å®šã®å¤‰æ›´ã‚’ä¿å­˜
            document.getElementById('goalDays').addEventListener('change', (e) => {
                appData.goalDays = parseInt(e.target.value, 10);
                saveData();
            });
            document.getElementById('enableNotifications').addEventListener('change', (e) => {
                appData.notifications = e.target.checked;
                if (appData.notifications) {
                    requestNotificationPermission();
                }
                saveData();
            });

            // Enterã‚­ãƒ¼ã§ã®æ´»å‹•è¿½åŠ 
            document.getElementById('addActivityInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addActivity();
            });
        }

        // ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ 
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
        }

        function showTab(tabId) {
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
            });
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’æ›´æ–°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabId);
            });
            
            // ç‰¹å®šã®ã‚¿ãƒ–ã§ã®è¿½åŠ å‡¦ç†
            if (tabId === 'analytics') {
                setTimeout(updateCharts, 100); // DOMæ›´æ–°å¾Œã«ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            }
            if (tabId === 'journal') {
                loadTodayJournal();
                renderJournalHistory();
            }
            if (tabId === 'achievements') {
                renderAchievements();
            }
            if (tabId === 'activities') {
                renderActivities();
            }
        }

        // ãƒ¡ã‚¤ãƒ³æ›´æ–°é–¢æ•°
        function updateAll() {
            updateStats();
            updateLevel();
            renderAchievements();
            renderActivities();
            saveData();
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const streak = getCurrentStreak();
            const longest = getLongestStreak();
            const total = appData.achievedDates.length;
            const rate = calculateSuccessRate();
            
            document.getElementById('currentStreak').textContent = streak;
            document.getElementById('longestStreak').textContent = longest;
            document.getElementById('totalDays').textContent = total;
            document.getElementById('successRate').textContent = rate;
        }

        // ãƒ¬ãƒ™ãƒ«æ›´æ–°
        function updateLevel() {
            const currentLevel = calculateLevel();
            const currentLevelData = levels[currentLevel - 1];
            // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã®XPã‚’æœ€å¤§XPã¨ã™ã‚‹
            const nextLevelData = levels[currentLevel] || { level: currentLevel + 1, xp: appData.totalXP + 100 }; 
            
            const currentXP = appData.totalXP - currentLevelData.xp;
            const maxXP = nextLevelData.xp - currentLevelData.xp;
            const progress = Math.min((currentXP / maxXP) * 100, 100);
            
            document.getElementById('userLevel').textContent = currentLevel;
            document.getElementById('currentXP').textContent = currentXP;
            document.getElementById('maxXP').textContent = maxXP;
            document.getElementById('xpProgress').style.width = progress + '%';
            document.getElementById('levelTitle').textContent = currentLevelData.title;
        }

        // ä»Šæ—¥ã®æˆåŠŸã‚’ãƒãƒ¼ã‚¯
        function markTodaySuccess() {
            const today = formatDate(new Date());
            if (!appData.achievedDates.includes(today)) {
                appData.achievedDates.push(today);
                appData.totalXP += 10; // çµŒé¨“å€¤ç²å¾—
                appData.achievedDates.sort((a, b) => new Date(a) - new Date(b)); // æ—¥ä»˜ã‚’ã‚½ãƒ¼ãƒˆ

                // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
                const oldLevel = calculateLevel();
                updateAll();
                const newLevel = calculateLevel();
                
                if (newLevel > oldLevel) {
                    showLevelUpMessage(newLevel);
                }
                
                showSuccessMessage();
                renderCalendar();
                checkAchievements();
                sendNotification('âœ… ç¦æ¬²ãƒãƒ£ãƒ¬ãƒ³ã‚¸', 'ä»Šæ—¥ã®ç¦æ¬²ã‚’é”æˆã—ã¾ã—ãŸï¼ç´ æ™´ã‚‰ã—ã„ï¼');
            } else {
                showModal('ä»Šæ—¥ã®é”æˆ', 'ä»Šæ—¥ã¯æ—¢ã«é”æˆæ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            }
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSuccessMessage() {
            const messages = [
                'ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼ãã®èª¿å­ï¼',
                'ğŸ”¥ ç¶™ç¶šã¯åŠ›ãªã‚Šï¼',
                'â­ ä»Šæ—¥ã‚‚ã‚ˆãé ‘å¼µã£ãŸï¼',
                'ğŸ’ª å›ãªã‚‰ã§ãã‚‹ï¼',
                'ğŸŒŸ ã¾ãŸä¸€æ­©å‰é€²ï¼',
                'ğŸ† å®Œç’§ã ï¼',
                'âœ¨ è‡ªåˆ†ã‚’èª‡ã‚Šã«æ€ã£ã¦ï¼'
            ];
            
            const message = messages[Math.floor(Math.random() * messages.length)];
            const messageEl = document.getElementById('congratsMessage');
            messageEl.innerHTML = `<h2>${message}</h2><p>çµŒé¨“å€¤ +10 ç²å¾—ï¼</p>`;
            messageEl.style.display = 'block';
            messageEl.classList.add('fade-in');
            
            setTimeout(() => {
                messageEl.style.display = 'none';
                messageEl.classList.remove('fade-in');
            }, 3000);
        }

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function showLevelUpMessage(level) {
            const levelData = levels[level - 1];
            showModal('ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼', `ãƒ¬ãƒ™ãƒ« ${level}: ${levelData.title}\n\nãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼`);
        }

        // ç·Šæ€¥ã‚µãƒãƒ¼ãƒˆ
        function toggleEmergencySection() {
            const section = document.getElementById('emergencySection');
            section.classList.toggle('hidden');
        }

        function startBreathingGuide() {
            let count = 0;
            const breathingSteps = ['å¸ã£ã¦...', 'æ­¢ã‚ã¦...', 'åã„ã¦...', 'æ­¢ã‚ã¦...'];
            const durations = [4000, 1000, 4000, 1000]; // ãƒŸãƒªç§’
            
            function nextStep() {
                if (count < 20) { // 5å›ç¹°ã‚Šè¿”ã—
                    const stepIndex = count % 4;
                    showModal('ğŸ« æ·±å‘¼å¸ã‚¬ã‚¤ãƒ‰', `${breathingSteps[stepIndex]} (${Math.floor(count/4) + 1}/5)`);
                    setTimeout(nextStep, durations[stepIndex]);
                    count++;
                } else {
                    showModal('ğŸŒŸ æ·±å‘¼å¸å®Œäº†ï¼', 'è½ã¡ç€ãã¾ã—ãŸã‹ï¼Ÿ');
                }
            }
            
            showModal('ğŸ« æ·±å‘¼å¸ã‚¬ã‚¤ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™', 'æŒ‡ç¤ºã«å¾“ã£ã¦å‘¼å¸ã—ã¦ãã ã•ã„ã€‚');
            setTimeout(nextStep, 1500); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«é–‹å§‹
        }

        function showMotivation() {
            const motivations = [
                'ğŸ¯ ã‚ãªãŸã®ç›®æ¨™ã‚’æ€ã„å‡ºã—ã¦ãã ã•ã„ï¼\nä»Šã¾ã§ç©ã¿é‡ã­ã¦ããŸåŠªåŠ›ã‚’ç„¡é§„ã«ã—ãªã„ã§ï¼',
                'ğŸ’ª ã“ã®ç¬é–“ã®èª˜æƒ‘ã¯ä¸€æ™‚çš„ã§ã™ã€‚\nå¾Œã§å¿…ãšå¾Œæ‚”ã™ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚',
                'ğŸŒŸ ä»Šæ—¥ã‚’ä¹—ã‚Šåˆ‡ã‚Œã°ã€æ˜æ—¥ã¯ã‚‚ã£ã¨å¼·ããªã‚Œã¾ã™ï¼',
                'ğŸ† ã‚ãªãŸã¯æ—¢ã«' + getCurrentStreak() + 'æ—¥ã‚‚ç¶™ç¶šã—ã¦ã„ã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„è¨˜éŒ²ã§ã™ï¼',
                'ğŸ”¥ ã“ã®æŒ‘æˆ¦ã‚’é€šã—ã¦ã€ã‚ãªãŸã¯æœ¬å½“ã®å¼·ã•ã‚’æ‰‹ã«å…¥ã‚Œã¦ã„ã¾ã™ã€‚',
                'â­ æœªæ¥ã®è‡ªåˆ†ãŒã‚ãªãŸã«æ„Ÿè¬ã™ã‚‹æ—¥ãŒæ¥ã¾ã™ã€‚ä»Šé ‘å¼µã£ã¦ï¼'
            ];
            
            const motivation = motivations[Math.floor(Math.random() * motivations.length)];
            showModal('ğŸ’ª ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è£œçµ¦', motivation);
        }

        function suggestDistraction() {
            if (appData.activities.length === 0) {
                showModal('ä»£æ›¿æ´»å‹•', 'ä»£æ›¿æ´»å‹•ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼');
                showTab('activities');
                return;
            }
            
            const activity = appData.activities[Math.floor(Math.random() * appData.activities.length)];
            showModal('ğŸ’¡ æ°—åˆ†è»¢æ›', `ä»Šã™ãã“ã‚Œã‚’ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼š\n\n"${activity}"\n\n5åˆ†ã ã‘ã§ã‚‚å§‹ã‚ã¦ã¿ã¦ãã ã•ã„ï¼`);
        }

        // æ—¥è¨˜æ©Ÿèƒ½
        function loadTodayJournal() {
            const today = formatDate(new Date());
            const entry = appData.journal[today] || '';
            document.getElementById('journalEntry').value = entry;
        }

        function saveJournal() {
            const today = formatDate(new Date());
            const entry = document.getElementById('journalEntry').value.trim();
            
            if (entry) {
                appData.journal[today] = entry;
                saveData();
                showModal('ğŸ“” æ—¥è¨˜', 'æ—¥è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                renderJournalHistory();
                checkAchievements(); // æ—¥è¨˜ä¿å­˜æ™‚ã«ã‚‚å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
            } else {
                showModal('ğŸ“” æ—¥è¨˜', 'æ—¥è¨˜ãŒç©ºã§ã™ã€‚ä½•ã‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function renderJournalHistory() {
            const history = document.getElementById('journalHistory');
            const entries = Object.entries(appData.journal)
                .sort(([a], [b]) => new Date(b) - new Date(a))
                .slice(0, 10); // æœ€æ–°10ä»¶
            
            if (entries.length === 0) {
                history.innerHTML = '<p style="opacity: 0.6;">ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            history.innerHTML = entries.map(([date, entry]) => `
                <div style="border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 1em; margin: 0.5em 0;">
                    <strong>${formatDateJapanese(parseDate(date))}</strong>
                    <p style="margin: 0.5em 0; opacity: 0.9;">${entry}</p>
                </div>
            `).join('');
        }

        // ä»£æ›¿æ´»å‹•
        function addActivity() {
            const input = document.getElementById('addActivityInput');
            const activity = input.value.trim();
            
            if (activity && !appData.activities.includes(activity)) {
                appData.activities.push(activity);
                input.value = '';
                saveData();
                renderActivities();
                checkAchievements(); // æ´»å‹•è¿½åŠ æ™‚ã«ã‚‚å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
            } else if (!activity) {
                showModal('æ´»å‹•è¿½åŠ ', 'æ´»å‹•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            } else {
                showModal('æ´»å‹•è¿½åŠ ', 'ãã®æ´»å‹•ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            }
        }

        function renderActivities() {
            const container = document.getElementById('activitiesList');
            
            if (appData.activities.length === 0) {
                container.innerHTML = '<p style="opacity: 0.6;">æ´»å‹•ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦è¡¨ç¤º
            const shuffled = [...appData.activities].sort(() => Math.random() - 0.5);
            
            container.innerHTML = shuffled.map((activity, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8em; margin: 0.5em 0; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <span>${activity}</span>
                    <button class="btn" style="padding: 0.3em 0.8em; font-size: 0.8em;" onclick="removeActivity('${activity}')">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        function removeActivity(activity) {
            showConfirm('æ´»å‹•ã®å‰Šé™¤', `'${activity}' ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`, () => {
                const index = appData.activities.indexOf(activity);
                if (index > -1) {
                    appData.activities.splice(index, 1);
                    saveData();
                    renderActivities();
                }
            });
        }

        // å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ 
        function checkAchievements() {
            const streak = getCurrentStreak();
            const longest = getLongestStreak();
            
            achievements.forEach(achievement => {
                if (!hasAchievement(achievement.id)) {
                    let unlocked = false;
                    
                    if (achievement.days && longest >= achievement.days) {
                        unlocked = true;
                    } else if (achievement.special === 'perfect_week' && checkPerfectWeek()) {
                        unlocked = true;
                    } else if (achievement.special === 'comeback' && checkComeback()) {
                        unlocked = true;
                    } else if (achievement.special === 'journal_count' && Object.keys(appData.journal).length >= achievement.count) {
                        unlocked = true;
                    } else if (achievement.special === 'activity_count' && appData.activities.length >= achievement.count) {
                        unlocked = true;
                    }
                    
                    if (unlocked) {
                        unlockAchievement(achievement.id);
                    }
                }
            });
        }

        function hasAchievement(id) {
            return appData.unlockedAchievements && appData.unlockedAchievements.includes(id);
        }

        function unlockAchievement(id) {
            if (!appData.unlockedAchievements) appData.unlockedAchievements = [];
            appData.unlockedAchievements.push(id);
            
            const achievement = achievements.find(a => a.id === id);
            appData.totalXP += 50; // å®Ÿç¸¾ã§ãƒœãƒ¼ãƒŠã‚¹XP
            
            setTimeout(() => {
                showModal('ğŸ† å®Ÿç¸¾è§£é™¤ï¼', `${achievement.icon} ${achievement.title}\n${achievement.desc}\n\nçµŒé¨“å€¤ +50 ç²å¾—ï¼`);
            }, 500);
            
            saveData();
            updateLevel();
        }

        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            
            grid.innerHTML = achievements.map(achievement => {
                const unlocked = hasAchievement(achievement.id);
                const progress = getAchievementProgress(achievement);
                
                return `
                    <div class="achievement ${unlocked ? 'unlocked' : ''}" title="${achievement.desc}${progress ? ' - ' + progress : ''}">
                        <div class="achievement-icon">${unlocked ? achievement.icon : 'ğŸ”’'}</div>
                        <div class="achievement-title">${achievement.title}</div>
                        ${progress ? `<div style="font-size: 0.7em; opacity: 0.8;">${progress}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function getAchievementProgress(achievement) {
            if (achievement.days) {
                const current = getLongestStreak();
                return current >= achievement.days ? 'é”æˆæ¸ˆã¿' : `${current}/${achievement.days}`;
            } else if (achievement.special === 'journal_count') {
                const current = Object.keys(appData.journal).length;
                return current >= achievement.count ? 'é”æˆæ¸ˆã¿' : `${current}/${achievement.count}`;
            } else if (achievement.special === 'activity_count') {
                const current = appData.activities.length;
                return current >= achievement.count ? 'é”æˆæ¸ˆã¿' : `${current}/${achievement.count}`;
            }
            return '';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        function renderCalendar() {
            const firstDay = new Date(viewYear, viewMonth, 1);
            const lastDay = new Date(viewYear, viewMonth + 1, 0);
            const startDay = firstDay.getDay(); // 0:æ—¥, 1:æœˆ, ..., 6:åœŸ
            
            document.getElementById('monthYear').textContent = `${viewYear}å¹´${viewMonth + 1}æœˆ`;
            
            let html = '<tr><th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th></tr>';
            
            let date = 1;
            for (let week = 0; week < 6; week++) {
                html += '<tr>';
                for (let day = 0; day < 7; day++) {
                    if (week === 0 && day < startDay) {
                        html += '<td></td>';
                    } else if (date > lastDay.getDate()) {
                        html += '<td></td>';
                    } else {
                        const currentDate = new Date(viewYear, viewMonth, date);
                        const dateKey = formatDate(currentDate);
                        const isToday = dateKey === formatDate(new Date());
                        const isAchieved = appData.achievedDates.includes(dateKey);
                        
                        let classes = [];
                        if (isToday) classes.push('today');
                        if (isAchieved) classes.push('achieved');
                        
                        html += `<td class="${classes.join(' ')}" onclick="toggleDate('${dateKey}')">${date}</td>`;
                        date++;
                    }
                }
                html += '</tr>';
                if (date > lastDay.getDate()) break;
            }
            
            document.getElementById('calendarTable').innerHTML = html;
        }

        function changeMonth(delta) {
            viewMonth += delta;
            if (viewMonth < 0) {
                viewYear--;
                viewMonth = 11;
            } else if (viewMonth > 11) {
                viewYear++;
                viewMonth = 0;
            }
            renderCalendar();
        }

        function toggleDate(dateKey) {
            // ä»Šæ—¥ã®æ—¥ä»˜ä»¥å¤–ã¯ãƒˆã‚°ãƒ«å¯èƒ½ã«ã™ã‚‹
            const today = formatDate(new Date());
            if (dateKey === today) {
                showModal('æ—¥ä»˜ã®å¤‰æ›´', 'ä»Šæ—¥ã®é”æˆçŠ¶æ³ã¯ã€Œä»Šæ—¥é”æˆï¼ã€ãƒœã‚¿ãƒ³ã§è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            showConfirm('æ—¥ä»˜ã®å¤‰æ›´', `${dateKey} ã®é”æˆçŠ¶æ³ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ`, () => {
                const index = appData.achievedDates.indexOf(dateKey);
                if (index >= 0) {
                    appData.achievedDates.splice(index, 1);
                    appData.totalXP = Math.max(0, appData.totalXP - 10);
                } else {
                    appData.achievedDates.push(dateKey);
                    appData.totalXP += 10;
                }
                
                appData.achievedDates.sort((a, b) => new Date(a) - new Date(b)); // ã‚½ãƒ¼ãƒˆ
                updateAll();
                renderCalendar();
                checkAchievements();
            });
        }

        // ãƒãƒ£ãƒ¼ãƒˆæ©Ÿèƒ½
        function initCharts() {
            // æœˆåˆ¥æˆåŠŸç‡ãƒãƒ£ãƒ¼ãƒˆ
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æœˆåˆ¥æˆåŠŸç‡ (%)',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: getChartTextColor() } }
                    },
                    scales: {
                        x: { ticks: { color: getChartTextColor() }, grid: { color: getChartGridColor() } },
                        y: { 
                            ticks: { color: getChartTextColor(), callback: function(value) { return value + '%'; } }, 
                            grid: { color: getChartGridColor() },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            // æ›œæ—¥åˆ¥æˆåŠŸç‡ãƒãƒ£ãƒ¼ãƒˆ
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            charts.weekly = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                    datasets: [{
                        label: 'æ›œæ—¥åˆ¥æˆåŠŸç‡ (%)',
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)', // æ—¥
                            'rgba(54, 162, 235, 0.6)', // æœˆ
                            'rgba(255, 206, 86, 0.6)', // ç«
                            'rgba(75, 192, 192, 0.6)', // æ°´
                            'rgba(153, 102, 255, 0.6)', // æœ¨
                            'rgba(255, 159, 64, 0.6)', // é‡‘
                            'rgba(199, 199, 199, 0.6)'  // åœŸ
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(199, 199, 199, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: getChartTextColor() } }
                    },
                    scales: {
                        x: { ticks: { color: getChartTextColor() }, grid: { color: getChartGridColor() } },
                        y: { 
                            ticks: { color: getChartTextColor(), callback: function(value) { return value + '%'; } }, 
                            grid: { color: getChartGridColor() },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            updateCharts(); // åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        }

        function updateCharts() {
            // æœˆåˆ¥æˆåŠŸç‡ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
            const monthlyData = calculateMonthlySuccessRates();
            charts.monthly.data.labels = monthlyData.labels;
            charts.monthly.data.datasets[0].data = monthlyData.data;
            charts.monthly.update();

            // æ›œæ—¥åˆ¥æˆåŠŸç‡ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
            const weeklyData = calculateWeeklySuccessRates();
            charts.weekly.data.datasets[0].data = weeklyData;
            charts.weekly.update();

            // ãƒãƒ£ãƒ¼ãƒˆã®ãƒ†ãƒ¼ãƒã‚’é©ç”¨
            charts.monthly.options.plugins.legend.labels.color = getChartTextColor();
            charts.monthly.options.scales.x.ticks.color = getChartTextColor();
            charts.monthly.options.scales.y.ticks.color = getChartTextColor();
            charts.monthly.options.scales.x.grid.color = getChartGridColor();
            charts.monthly.options.scales.y.grid.color = getChartGridColor();
            charts.monthly.update();

            charts.weekly.options.plugins.legend.labels.color = getChartTextColor();
            charts.weekly.options.scales.x.ticks.color = getChartTextColor();
            charts.weekly.options.scales.y.ticks.color = getChartTextColor();
            charts.weekly.options.scales.x.grid.color = getChartGridColor();
            charts.weekly.options.scales.y.grid.color = getChartGridColor();
            charts.weekly.update();
        }

        function getChartTextColor() {
            return appData.theme === 'dark' ? '#ddd' : '#333';
        }

        function getChartGridColor() {
            return appData.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function formatDate(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function parseDate(dateString) {
            const [y, m, d] = dateString.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function formatDateJapanese(date) {
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
            return `${y}å¹´${m}æœˆ${d}æ—¥(${dayOfWeek})`;
        }

        function getDaysBetween(d1, d2) {
            const date1 = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
            const date2 = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
            const diffTime = Math.abs(date2 - date1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—
        function getCurrentStreak() {
            if (appData.achievedDates.length === 0) return 0;

            let streak = 0;
            let currentDate = new Date();
            let lastAchievedDate = parseDate(appData.achievedDates[appData.achievedDates.length - 1]);

            // ä»Šæ—¥ã®æ—¥ä»˜ãŒé”æˆæ¸ˆã¿ã§ãªã„ã€ã‹ã¤æ˜¨æ—¥ã‚‚é”æˆæ¸ˆã¿ã§ãªã„å ´åˆã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã¯0
            if (formatDate(currentDate) !== formatDate(lastAchievedDate) && getDaysBetween(currentDate, lastAchievedDate) > 1) {
                return 0;
            }

            // ä»Šæ—¥ãŒé”æˆæ¸ˆã¿ã€ã¾ãŸã¯æ˜¨æ—¥ãŒé”æˆæ¸ˆã¿ã®å ´åˆã€ãã“ã‹ã‚‰é¡ã£ã¦ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’è¨ˆç®—
            let tempDate = new Date(lastAchievedDate);
            for (let i = appData.achievedDates.length - 1; i >= 0; i--) {
                const date = parseDate(appData.achievedDates[i]);
                if (formatDate(date) === formatDate(tempDate)) {
                    streak++;
                    tempDate.setDate(tempDate.getDate() - 1); // å‰æ—¥ã¸
                } else if (getDaysBetween(date, tempDate) === 0) { // åŒã˜æ—¥ä»˜ãŒè¤‡æ•°ã‚ã£ãŸå ´åˆï¼ˆã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
                    continue;
                } else {
                    break; // é€£ç¶šãŒé€”åˆ‡ã‚ŒãŸ
                }
            }
            return streak;
        }

        function getLongestStreak() {
            if (appData.achievedDates.length === 0) return 0;

            let maxStreak = 0;
            let currentStreak = 0;
            
            // achievedDatesã¯ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å‰æ
            for (let i = 0; i < appData.achievedDates.length; i++) {
                if (i === 0) {
                    currentStreak = 1;
                } else {
                    const prevDate = parseDate(appData.achievedDates[i - 1]);
                    const currentDate = parseDate(appData.achievedDates[i]);
                    if (getDaysBetween(prevDate, currentDate) === 1) {
                        currentStreak++;
                    } else if (getDaysBetween(prevDate, currentDate) === 0) { // åŒã˜æ—¥ä»˜ã¯ã‚¹ã‚­ãƒƒãƒ—
                        continue;
                    } else {
                        maxStreak = Math.max(maxStreak, currentStreak);
                        currentStreak = 1;
                    }
                }
                maxStreak = Math.max(maxStreak, currentStreak); // ãƒ«ãƒ¼ãƒ—ã®æœ€å¾Œã«æ›´æ–°
            }
            return maxStreak;
        }

        function calculateSuccessRate() {
            if (appData.achievedDates.length === 0) return 0;

            // ã‚¢ãƒ—ãƒªé–‹å§‹æ—¥ã‚’ç‰¹å®š
            const firstDate = parseDate(appData.achievedDates[0]);
            const today = new Date();
            const totalPossibleDays = getDaysBetween(firstDate, today) + 1; // é–‹å§‹æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®ç·æ—¥æ•°

            return ((appData.achievedDates.length / totalPossibleDays) * 100).toFixed(1);
        }

        function calculateLevel() {
            let currentLevel = 1;
            for (let i = 0; i < levels.length; i++) {
                if (appData.totalXP >= levels[i].xp) {
                    currentLevel = levels[i].level;
                } else {
                    break;
                }
            }
            return currentLevel;
        }

        // å®Ÿç¸¾ã®ç‰¹æ®Šæ¡ä»¶ãƒã‚§ãƒƒã‚¯
        function checkPerfectWeek() {
            if (appData.achievedDates.length < 7) return false;

            const sortedDates = [...appData.achievedDates].map(d => new Date(d)).sort((a, b) => b - a); // æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆ

            for (let i = 0; i <= sortedDates.length - 7; i++) {
                let isPerfect = true;
                for (let j = 0; j < 7; j++) {
                    const dateToCheck = new Date(sortedDates[i]);
                    dateToCheck.setDate(dateToCheck.getDate() - j); // é¡ã‚‹
                    if (!appData.achievedDates.includes(formatDate(dateToCheck))) {
                        isPerfect = false;
                        break;
                    }
                }
                if (isPerfect) return true;
            }
            return false;
        }

        function checkComeback() {
            // å¤±æ•—å¾Œå¾©æ´»ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€ä¾‹ãˆã°ã€Œã‚¹ãƒˆãƒªãƒ¼ã‚¯ãŒ0ã«ãªã£ãŸå¾Œã€å†åº¦1æ—¥é”æˆã—ãŸã€ãªã©ã§åˆ¤å®šã§ãã¾ã™ã€‚
            // ã“ã“ã§ã¯ã€ç›´è¿‘ã®é”æˆæ—¥ãŒéå»ã«ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãŒé€”åˆ‡ã‚ŒãŸå¾Œã«è¨˜éŒ²ã•ã‚ŒãŸå ´åˆã‚’ç°¡æ˜“çš„ã«åˆ¤å®šã—ã¾ã™ã€‚
            // ã‚ˆã‚Šå³å¯†ã«ã™ã‚‹ã«ã¯ã€éå»ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            if (appData.achievedDates.length < 2) return false;

            const sortedDates = [...appData.achievedDates].map(d => new Date(d)).sort((a, b) => a - b); // å¤ã„é †ã«ã‚½ãƒ¼ãƒˆ

            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = sortedDates[i - 1];
                const currentDate = sortedDates[i];
                // 2æ—¥ä»¥ä¸Šé–“ãŒç©ºã„ã¦ã„ãŸã‚‰ã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãŒé€”åˆ‡ã‚ŒãŸã¨ã¿ãªã™
                if (getDaysBetween(prevDate, currentDate) > 1) {
                    return true; // é€”åˆ‡ã‚ŒãŸå¾Œã«å†é–‹ã—ãŸ
                }
            }
            return false;
        }


        function calculateMonthlySuccessRates() {
            const monthlyStats = {}; // { 'YYYY-MM': { totalDays: 0, achievedDays: 0 } }

            // ãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹æœ€åˆã®æœˆã‹ã‚‰ç¾åœ¨ã®æœˆã¾ã§ã‚’å¯¾è±¡
            let startDate = appData.achievedDates.length > 0 ? parseDate(appData.achievedDates[0]) : new Date();
            let endDate = new Date();

            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

            while (currentMonth <= endDate) {
                const yearMonth = `${currentMonth.getFullYear()}-${(currentMonth.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyStats[yearMonth] = { totalDays: 0, achievedDays: 0 };
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }

            // å„æœˆã®ç·æ—¥æ•°ã¨é”æˆæ—¥æ•°ã‚’è¨ˆç®—
            for (const dateStr of appData.achievedDates) {
                const date = parseDate(dateStr);
                const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                if (monthlyStats[yearMonth]) {
                    monthlyStats[yearMonth].achievedDays++;
                }
            }

            // å„æœˆã®ç·æ—¥æ•°ã‚’è¨ˆç®—
            for (const monthKey in monthlyStats) {
                const [year, month] = monthKey.split('-').map(Number);
                const daysInMonth = new Date(year, month, 0).getDate();
                monthlyStats[monthKey].totalDays = daysInMonth;
            }

            // ç¾åœ¨ã®æœˆã¯ä»Šæ—¥ã¾ã§ã®æ—¥æ•°ã§è¨ˆç®—
            const currentYearMonth = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
            if (monthlyStats[currentYearMonth]) {
                monthlyStats[currentYearMonth].totalDays = endDate.getDate(); // ä»Šæœˆã¯ä»Šæ—¥ã¾ã§ã®æ—¥æ•°
            }

            const labels = [];
            const data = [];

            // æœˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            Object.keys(monthlyStats).sort().forEach(monthKey => {
                labels.push(monthKey);
                const stats = monthlyStats[monthKey];
                const rate = stats.totalDays > 0 ? ((stats.achievedDays / stats.totalDays) * 100).toFixed(1) : 0;
                data.push(rate);
            });

            return { labels, data };
        }

        function calculateWeeklySuccessRates() {
            const weeklyStats = new Array(7).fill(0).map(() => ({ total: 0, achieved: 0 })); // æ—¥-åœŸ

            for (const dateStr of appData.achievedDates) {
                const date = parseDate(dateStr);
                const dayOfWeek = date.getDay(); // 0:æ—¥, 1:æœˆ, ..., 6:åœŸ
                weeklyStats[dayOfWeek].achieved++;
            }

            // å…¨æœŸé–“ã®å„æ›œæ—¥ã®ç·æ—¥æ•°ã‚’è¨ˆç®—
            if (appData.achievedDates.length > 0) {
                const firstDate = parseDate(appData.achievedDates[0]);
                const today = new Date();
                let tempDate = new Date(firstDate);

                while (tempDate <= today) {
                    const dayOfWeek = tempDate.getDay();
                    weeklyStats[dayOfWeek].total++;
                    tempDate.setDate(tempDate.getDate() + 1);
                }
            } else { // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€éå»7æ—¥é–“ã®æ›œæ—¥ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const tempDate = new Date(today);
                    tempDate.setDate(today.getDate() - i);
                    const dayOfWeek = tempDate.getDay();
                    weeklyStats[dayOfWeek].total++;
                }
            }


            const rates = weeklyStats.map(stats => {
                return stats.total > 0 ? ((stats.achieved / stats.total) * 100).toFixed(1) : 0;
            });

            return rates;
        }


        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            appData.theme = appData.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveData();
            updateCharts(); // ãƒãƒ£ãƒ¼ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å†æç”»
        }

        function applyTheme() {
            document.body.classList.toggle('light-mode', appData.theme === 'light');
            document.getElementById('themeToggle').textContent = appData.theme === 'dark' ? 'ğŸŒ“ ãƒ†ãƒ¼ãƒåˆ‡æ›¿' : 'â˜€ï¸ ãƒ†ãƒ¼ãƒåˆ‡æ›¿';
        }

        // ä»Šæ—¥ã®åè¨€è¡¨ç¤º
        function showDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            const quote = quotes[quoteIndex];
            document.getElementById('quoteText').textContent = `"${quote.text}"`;
            document.getElementById('quoteAuthor').textContent = `- ${quote.author}`;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'abstinence_challenge_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showModal('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸï¼');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ã™ã‚‹ã‹ã€å®Œå…¨ã«ç½®ãæ›ãˆã‚‹ã‹é¸æŠè‚¢ã‚’ä¸ãˆã‚‹ã“ã¨ã‚‚å¯èƒ½
                    showConfirm('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ', () => {
                        appData = { ...appData, ...importedData }; // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã
                        appData.achievedDates.sort((a, b) => new Date(a) - new Date(b)); // æ—¥ä»˜ã‚’ã‚½ãƒ¼ãƒˆ
                        saveData();
                        init(); // ã‚¢ãƒ—ãƒªã‚’å†åˆæœŸåŒ–ã—ã¦UIã‚’æ›´æ–°
                        showModal('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸï¼');
                    });
                } catch (error) {
                    showModal('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼', 'JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                    console.error('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                }
            };
            reader.readAsText(file);
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetAll() {
            showConfirm('ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ', 'å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚', () => {
                localStorage.removeItem('enhancedAbstinenceData');
                appData = {
                    achievedDates: [],
                    totalXP: 0,
                    level: 1,
                    journal: {},
                    activities: [
                        '30åˆ†é‹å‹•ã™ã‚‹', 'æœ¬ã‚’20ãƒšãƒ¼ã‚¸èª­ã‚€', 'ç‘æƒ³ã™ã‚‹', 'æ•£æ­©ã«å‡ºã‚‹', 'å‹é”ã«é€£çµ¡',
                        'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªä½œæ¥­', 'éƒ¨å±‹ã‚’æ•´ç†', 'æ–°ã—ã„ã‚¹ã‚­ãƒ«å­¦ç¿’', 'æ–™ç†ã‚’ã™ã‚‹', 'éŸ³æ¥½ã‚’è´ã'
                    ],
                    theme: 'dark',
                    goalDays: 30,
                    notifications: false,
                    streakProtections: 3,
                    unlockedAchievements: []
                };
                init();
                showModal('ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ', 'å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            });
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
        function showModal(title, message, callback = null) {
            const modalOverlay = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.classList.add('btn');
            okButton.onclick = () => {
                modalOverlay.classList.remove('visible');
                if (callback) callback();
            };
            modalButtons.appendChild(okButton);

            modalOverlay.classList.add('visible');
        }

        function showConfirm(title, message, onConfirm, onCancel = null) {
            const modalOverlay = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'ã¯ã„';
            confirmButton.classList.add('btn', 'primary');
            confirmButton.onclick = () => {
                modalOverlay.classList.remove('visible');
                if (onConfirm) onConfirm();
            };
            modalButtons.appendChild(confirmButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'ã„ã„ãˆ';
            cancelButton.classList.add('btn');
            cancelButton.onclick = () => {
                modalOverlay.classList.remove('visible');
                if (onCancel) onCancel();
            };
            modalButtons.appendChild(cancelButton);

            modalOverlay.classList.add('visible');
        }

        // é€šçŸ¥æ©Ÿèƒ½
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showModal('é€šçŸ¥', 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            if (Notification.permission === "granted") {
                console.log("é€šçŸ¥ã¯æ—¢ã«è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showModal('é€šçŸ¥', 'é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼');
                        appData.notifications = true;
                        saveData();
                    } else {
                        showModal('é€šçŸ¥', 'é€šçŸ¥ã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‹ã‚‰ã„ã¤ã§ã‚‚æœ‰åŠ¹ã«ã§ãã¾ã™ã€‚');
                        appData.notifications = false;
                        document.getElementById('enableNotifications').checked = false;
                        saveData();
                    }
                });
            } else {
                showModal('é€šçŸ¥', 'é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                appData.notifications = false;
                document.getElementById('enableNotifications').checked = false;
                saveData();
            }
        }

        function sendNotification(title, body) {
            if (appData.notifications && Notification.permission === "granted") {
                new Notification(title, { body: body, icon: 'https://placehold.co/64x64/FF6B6B/FFFFFF?text=ğŸ”¥' });
            }
        }

        // ã‚¢ãƒ—ãƒªèµ·å‹•
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
