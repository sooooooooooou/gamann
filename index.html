<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Ë∂ÖÂº∑ÂåñÁâàÁ¶ÅÊ¨≤„ÉÅ„É£„É¨„É≥„Ç∏ üî•</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ddd;
            overflow-y: auto;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1em;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            text-align: center;
            position: relative;
            margin-bottom: 2em;
        }

        .header h1 {
            font-size: 2.5em;
            margin: 0.5em 0;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.3)); }
            to { filter: drop-shadow(0 0 20px rgba(255, 107, 107, 0.6)); }
        }

        /* „ÉÜ„Éº„Éû„Éà„Ç∞„É´ */
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 0.5em 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* „Ç´„Éº„ÉâÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5em;
            margin: 1em 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
        }

        /* „É¨„Éô„É´„Ç∑„Çπ„ÉÜ„É† */
        .level-section {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .level-display {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }

        .xp-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 1em 0;
        }

        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, #feca57, #ff9ff3);
            border-radius: 10px;
            transition: width 1s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Áµ±Ë®à„Ç∞„É™„ÉÉ„Éâ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1em;
            margin: 1em 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 1.5em;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 0.5em;
        }

        /* ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É† */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1em;
            margin: 1em 0;
        }

        .achievement {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1em;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .achievement-icon {
            font-size: 2em;
            margin-bottom: 0.5em;
        }

        .achievement-title {
            font-size: 0.8em;
            font-weight: bold;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 0.8em 1.5em;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 0.3em;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            font-size: 1.2em;
            padding: 1em 2em;
        }

        /* Êó•Ë®ò„Çª„ÇØ„Ç∑„Éß„É≥ */
        .journal-entry {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1em;
            color: #ddd;
            font-family: inherit;
            resize: vertical;
        }

        /* Á∑äÊÄ•„Çµ„Éù„Éº„Éà */
        .emergency-section {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            text-align: center;
            animation: emergencyPulse 2s ease-in-out infinite;
        }

        @keyframes emergencyPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .emergency-section.hidden {
            display: none;
        }

        /* „Ç´„É¨„É≥„ÉÄ„ÉºÂº∑Âåñ */
        .calendar {
            background: rgba(255, 255, 255, 0.03);
        }

        .calendar table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .calendar th,
        .calendar td {
            padding: 1em;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .calendar td:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .calendar .achieved {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            font-weight: bold;
        }

        .calendar .today {
            border: 3px solid #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }

        /* ÂêçË®ÄË°®Á§∫ */
        .quote-section {
            background: linear-gradient(135deg, #5f27cd, #341f97);
            text-align: center;
            font-style: italic;
            position: relative;
        }

        .quote-text {
            font-size: 1.2em;
            margin-bottom: 0.5em;
        }

        .quote-author {
            opacity: 0.8;
            font-size: 0.9em;
        }

        /* „ÉÅ„É£„Éº„Éà */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1em 0;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .stats-grid { grid-template-columns: 1fr; }
            .achievements-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .theme-toggle { position: relative; margin: 1em 0; }
        }

        /* „É©„Ç§„Éà„É¢„Éº„Éâ */
        body.light-mode {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #333;
        }

        body.light-mode .card {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode .xp-bar {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .xp-progress {
            background: linear-gradient(90deg, #feca57, #ff9ff3); /* Âêå„Åò„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÇíÁ∂≠ÊåÅ */
        }

        body.light-mode .calendar th,
        body.light-mode .calendar td {
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .calendar td:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .journal-entry,
        body.light-mode #addActivityInput {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode #activitiesList div {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode .chart-container canvas {
            background-color: rgba(255, 255, 255, 0.8); /* „ÉÅ„É£„Éº„ÉàËÉåÊôØ„ÇÇÊòé„Çã„Åè */
            border-radius: 15px;
        }

        /* „Çø„Éñ„Ç∑„Çπ„ÉÜ„É† */
        .tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2em;
            overflow-x: auto;
        }

        body.light-mode .tabs {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 1em 2em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        body.light-mode .tab.active {
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        /* „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #2a2a4a;
            border-radius: 15px;
            padding: 2em;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #ddd;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #feca57;
        }

        .modal-content p {
            margin-bottom: 1.5em;
        }

        .modal-buttons button {
            margin: 0 0.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="header">
            <h1>üî• Ë∂ÖÂº∑ÂåñÁâàÁ¶ÅÊ¨≤„ÉÅ„É£„É¨„É≥„Ç∏ üî•</h1>
            <button class="theme-toggle" id="themeToggle">üåì „ÉÜ„Éº„ÉûÂàáÊõø</button>
        </div>

        <!-- „É¨„Éô„É´„Ç∑„Çπ„ÉÜ„É† -->
        <div class="card level-section">
            <div class="level-display">„É¨„Éô„É´ <span id="userLevel">1</span></div>
            <div>ÁµåÈ®ìÂÄ§: <span id="currentXP">0</span> / <span id="maxXP">100</span></div>
            <div class="xp-bar">
                <div class="xp-progress" id="xpProgress"></div>
            </div>
            <div id="levelTitle">ÂàùÂøÉËÄÖ</div>
        </div>

        <!-- ‰ªäÊó•„ÅÆÂêçË®Ä -->
        <div class="card quote-section" id="quoteSection">
            <div class="quote-text" id="quoteText"></div>
            <div class="quote-author" id="quoteAuthor"></div>
        </div>

        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</div>
            <div class="tab" data-tab="calendar">üìÖ „Ç´„É¨„É≥„ÉÄ„Éº</div>
            <div class="tab" data-tab="achievements">üèÜ ÂÆüÁ∏æ</div>
            <div class="tab" data-tab="journal">üìî Êó•Ë®ò</div>
            <div class="tab" data-tab="activities">üí° ‰ª£ÊõøÊ¥ªÂãï</div>
            <div class="tab" data-tab="analytics">üìà ÂàÜÊûê</div>
            <div class="tab" data-tab="settings">‚öôÔ∏è Ë®≠ÂÆö</div>
        </div>

        <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Çø„Éñ -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">ÁèæÂú®„ÅÆ„Çπ„Éà„É™„Éº„ÇØ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="longestStreak">0</div>
                    <div class="stat-label">ÊúÄÈï∑Ë®òÈå≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDays">0</div>
                    <div class="stat-label">Á∑èÊàêÂäüÊó•Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0</div>
                    <div class="stat-label">ÊàêÂäüÁéá (%)</div>
                </div>
            </div>

            <div style="text-align: center; margin: 2em 0;">
                <button class="btn primary" id="markSuccessBtn">‚úÖ ‰ªäÊó•ÈÅîÊàêÔºÅ</button>
                <button class="btn" id="emergencyBtn">üö® Á∑äÊÄ•„Çµ„Éù„Éº„Éà</button>
            </div>

            <div class="card emergency-section hidden" id="emergencySection">
                <h2>üö® Á∑äÊÄ•„Çµ„Éù„Éº„Éà üö®</h2>
                <p>Ê∑±ÂëºÂê∏„Åó„Å¶„ÄÅ„Å™„Åú„Åì„Åì„Åæ„ÅßÈ†ëÂºµ„Å£„Å¶„Åç„Åü„ÅÆ„ÅãÊÄù„ÅÑÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <button class="btn" id="breathingBtn">ü´Å Ê∑±ÂëºÂê∏„Ç¨„Ç§„Éâ</button>
                <button class="btn" id="motivationBtn">üí™ „É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Ë£úÁµ¶</button>
                <button class="btn" id="distractionBtn">üéØ Ê∞óÂàÜËª¢Êèõ</button>
            </div>

            <div id="congratsMessage" class="card" style="display: none; background: linear-gradient(135deg, #00b894, #55a3ff); text-align: center;"></div>
        </div>

        <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ -->
        <div class="tab-content" id="calendar">
            <div class="card calendar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
                    <button class="btn" id="prevMonth">‚Üê ÂâçÊúà</button>
                    <h2 id="monthYear"></h2>
                    <button class="btn" id="nextMonth">Ê¨°Êúà ‚Üí</button>
                </div>
                <table id="calendarTable"></table>
            </div>
        </div>

        <!-- ÂÆüÁ∏æ„Çø„Éñ -->
        <div class="tab-content" id="achievements">
            <div class="card">
                <h2>üèÜ ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É†</h2>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
        </div>

        <!-- Êó•Ë®ò„Çø„Éñ -->
        <div class="tab-content" id="journal">
            <div class="card">
                <h2>üìî ‰ªäÊó•„ÅÆÊó•Ë®ò</h2>
                <textarea class="journal-entry" id="journalEntry" placeholder="‰ªäÊó•„ÅØ„Å©„Çì„Å™‰∏ÄÊó•„Åß„Åó„Åü„ÅãÔºüÊÑü„Åò„Åü„Åì„Å®„ÇÑÂ≠¶„Çì„Å†„Åì„Å®„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                <div style="text-align: center; margin-top: 1em;">
                    <button class="btn" id="saveJournalBtn">üíæ ‰øùÂ≠ò</button>
                </div>
            </div>
            
            <div class="card">
                <h3>üìö ÈÅéÂéª„ÅÆÊó•Ë®ò</h3>
                <div id="journalHistory"></div>
            </div>
        </div>

        <!-- ‰ª£ÊõøÊ¥ªÂãï„Çø„Éñ -->
        <div class="tab-content" id="activities">
            <div class="card">
                <h2>üí° ‰ª£„Çè„Çä„Å´„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà</h2>
                <div style="margin: 1em 0;">
                    <input type="text" id="addActivityInput" placeholder="Êñ∞„Åó„ÅÑÊ¥ªÂãï„ÇíËøΩÂä†..." 
                            style="width: 70%; padding: 0.8em; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ddd;">
                    <button class="btn" id="addActivityBtn">‚ûï ËøΩÂä†</button>
                </div>
                <div id="activitiesList"></div>
            </div>
        </div>

        <!-- ÂàÜÊûê„Çø„Éñ -->
        <div class="tab-content" id="analytics">
            <div class="card">
                <h2>üìà ÊàêÂäüÁéáÂàÜÊûê</h2>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>üìä ÊõúÊó•Âà•ÊàêÂäüÁéá</h2>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ë®≠ÂÆö„Çø„Éñ -->
        <div class="tab-content" id="settings">
            <div class="card">
                <h2>‚öôÔ∏è Ë®≠ÂÆö</h2>
                <div style="margin: 1em 0;">
                    <label>
                        <input type="checkbox" id="enableNotifications"> ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã
                    </label>
                </div>
                <div style="margin: 1em 0;">
                    <label>
                        ÁõÆÊ®ôÊó•Êï∞: <input type="number" id="goalDays" value="30" min="1" style="width: 80px; padding: 0.5em; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #ddd;">
                    </label>
                </div>
                <div style="text-align: center; margin-top: 2em;">
                    <button class="btn" id="exportBtn">üíæ „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="btn" id="importBtn">üìÇ „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                    <button class="btn" id="resetBtn" style="background: linear-gradient(135deg, #ff4757, #ff3838);">üîÑ „É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".json" style="display:none;">

    <!-- „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥† -->
    <div class="modal-overlay" id="customModal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons" id="modalButtons">
                <!-- „Éú„Çø„É≥„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
            </div>
        </div>
    </div>

    <script>
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áä∂ÊÖã
        let appData = {
            achievedDates: [],
            totalXP: 0,
            level: 1,
            journal: {},
            activities: [
                '30ÂàÜÈÅãÂãï„Åô„Çã', 'Êú¨„Çí20„Éö„Éº„Ç∏Ë™≠„ÇÄ', 'ÁûëÊÉ≥„Åô„Çã', 'Êï£Ê≠©„Å´Âá∫„Çã', 'ÂèãÈÅî„Å´ÈÄ£Áµ°',
                '„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„Éñ„Å™‰ΩúÊ•≠', 'ÈÉ®Â±ã„ÇíÊï¥ÁêÜ', 'Êñ∞„Åó„ÅÑ„Çπ„Ç≠„É´Â≠¶Áøí', 'ÊñôÁêÜ„Çí„Åô„Çã', 'Èü≥Ê•Ω„ÇíËÅ¥„Åè'
            ],
            theme: 'dark',
            goalDays: 30,
            notifications: false,
            streakProtections: 3, // „Çπ„Éà„É™„Éº„ÇØ‰øùË≠∑Ê©üËÉΩ„ÅÆËøΩÂä†
            unlockedAchievements: [] // ÂÆüÁ∏æ„ÅÆ„É≠„ÉÉ„ÇØËß£Èô§Áä∂ÊÖã„ÇíËøΩË∑°
        };

        // ÂêçË®ÄÈõÜ
        const quotes = [
            { text: "ÊàêÂäü„ÅØÊ∫ñÂÇô„Å®Ê©ü‰ºö„ÅåÂá∫‰ºö„ÅÜ„Å®„Åì„Çç„Å´Áîü„Åæ„Çå„Çã", author: "„Çª„Éç„Ç´" },
            { text: "Ëá™Âà∂ÂøÉ„ÅØÁ≠ãËÇâ„ÅÆ„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„ÄÇ‰Ωø„Åà„Å∞‰Ωø„ÅÜ„Åª„Å©Âº∑„Åè„Å™„Çã", author: "‰∏çÊòé" },
            { text: "ÊÑèÂøó„ÅÆÂäõ„ÅØ„ÄÅÁπ∞„ÇäËøî„Åó„ÅÆÂäõ„Åß„ÅÇ„Çã", author: "‰∏çÊòé" },
            { text: "‰ªäÊó•„ÅÆËá™ÂàÜ„ÅØ„ÄÅÊò®Êó•„ÅÆÈÅ∏Êäû„ÅÆÁµêÊûú„Åß„ÅÇ„Çã", author: "‰∏çÊòé" },
            { text: "Â∞è„Åï„Å™‰∏ÄÊ≠©„Åß„ÇÇ„ÄÅÊ≠£„Åó„ÅÑÊñπÂêë„Å∏„ÅÆ‰∏ÄÊ≠©„Åß„ÅÇ„Çã", author: "‰∏çÊòé" },
            { text: "Â§âÂåñ„ÅØÊ±∫Êñ≠„Åã„ÇâÂßã„Åæ„Çã", author: "„Éà„Éã„Éº„Éª„É≠„Éì„É≥„Ç∫" },
            { text: "Âõ∞Èõ£„ÅØÊàêÈï∑„ÅÆÊ©ü‰ºö„Åß„ÅÇ„Çã", author: "‰∏çÊòé" },
            { text: "Á∂ôÁ∂ö„ÅØÂäõ„Å™„Çä", author: "Êó•Êú¨„ÅÆ„Åì„Å®„Çè„Åñ" }
        ];

        // ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É†
        const achievements = [
            { id: 'first_day', icon: 'üå±', title: 'Á¨¨‰∏ÄÊ≠©', desc: '1Êó•ÈÅîÊàê', days: 1 },
            { id: 'week_warrior', icon: '‚ö°', title: 'ÈÄ±„ÅÆÊà¶Â£´', desc: '7Êó•ÈÅîÊàê', days: 7 },
            { id: 'month_master', icon: 'üèÖ', title: 'Êúà„ÅÆÈÅî‰∫∫', desc: '30Êó•ÈÅîÊàê', days: 30 },
            { id: 'legend', icon: 'üëë', title: '‰ºùË™¨', desc: '100Êó•ÈÅîÊàê', days: 100 },
            { id: 'godlike', icon: 'üèÜ', title: 'Á•û„ÅÆÂüü', desc: '365Êó•ÈÅîÊàê', days: 365 },
            { id: 'perfect_week', icon: 'üíé', title: 'ÂÆåÁíß„Å™ÈÄ±', desc: 'ÈÄ±7Êó•ÈÄ£Á∂ö', special: 'perfect_week' },
            { id: 'comeback_king', icon: 'üîÑ', title: 'Âæ©Ê¥ªÁéã', desc: 'Â§±ÊïóÂæåÂæ©Ê¥ª', special: 'comeback' },
            { id: 'journal_keeper', icon: '‚úçÔ∏è', title: 'Êó•Ë®ò„ÅÆÈÅî‰∫∫', desc: 'Êó•Ë®ò„Çí10ÂõûË®òÈå≤', special: 'journal_count', count: 10 },
            { id: 'activity_master', icon: 'üèÉ', title: 'Ê¥ªÂãï„ÅÆÈÅî‰∫∫', desc: '‰ª£ÊõøÊ¥ªÂãï„Çí5„Å§ËøΩÂä†', special: 'activity_count', count: 5 }
        ];

        // „É¨„Éô„É´„Ç∑„Çπ„ÉÜ„É†
        const levels = [
            { level: 1, xp: 0, title: 'ÂàùÂøÉËÄÖ' },
            { level: 2, xp: 100, title: 'ÊåëÊà¶ËÄÖ' },
            { level: 3, xp: 300, title: 'Êà¶Â£´' },
            { level: 4, xp: 600, title: 'ÈÅî‰∫∫' },
            { level: 5, xp: 1000, title: '„Éû„Çπ„Çø„Éº' },
            { level: 6, xp: 1500, title: '‰ºùË™¨' },
            { level: 7, xp: 2100, title: 'Á•ûË©±' },
            { level: 8, xp: 2800, title: '‰∏çÊ≠ªË∫´' },
            { level: 9, xp: 3600, title: 'Ë∂ÖË∂äËÄÖ' },
            { level: 10, xp: 4500, title: 'ÂÆåÂÖ®‰Ωì' }
        ];

        // ÁèæÂú®„ÅÆË°®Á§∫Êúà
        let viewYear, viewMonth;
        let charts = {};

        // ÂàùÊúüÂåñ
        function init() {
            loadData();
            setupEventListeners();
            setupTabs();
            updateAll();
            showDailyQuote();
            
            const today = new Date();
            viewYear = today.getFullYear();
            viewMonth = today.getMonth();
            
            renderCalendar();
            initCharts();
            applyTheme();

            // ÁõÆÊ®ôÊó•Êï∞„ÇíË®≠ÂÆö„Å´ÂèçÊò†
            document.getElementById('goalDays').value = appData.goalDays;
            document.getElementById('enableNotifications').checked = appData.notifications;

            // ÈÄöÁü•Ê®©Èôê„ÅÆÁ¢∫Ë™ç
            if (appData.notifications && Notification.permission !== "granted") {
                requestNotificationPermission();
            }
        }

        // „Éá„Éº„ÇøÈñ¢ÈÄ£
        function loadData() {
            const saved = localStorage.getItem('enhancedAbstinenceData');
            if (saved) {
                try {
                    // „É≠„Éº„ÉâÊôÇ„Å´„Éá„Éï„Ç©„É´„ÉàÂÄ§„Çí„Éû„Éº„Ç∏„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„Éó„É≠„Éë„ÉÜ„Ç£„ÅåËøΩÂä†„Åï„Çå„Å¶„ÇÇÂ£ä„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                    const loadedData = JSON.parse(saved);
                    appData = { ...appData, ...loadedData };
                    // achievedDates„ÅØÊó•‰ªòÊñáÂ≠óÂàó„ÅÆÈÖçÂàó„Å™„ÅÆ„Åß„ÄÅ„ÇΩ„Éº„Éà„Åó„Å¶„Åä„Åè
                    appData.achievedDates.sort((a, b) => new Date(a) - new Date(b));
                } catch(e) {
                    console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
                }
            }
        }

        function saveData() {
            localStorage.setItem('enhancedAbstinenceData', JSON.stringify(appData));
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            document.getElementById('markSuccessBtn').addEventListener('click', markTodaySuccess);
            document.getElementById('emergencyBtn').addEventListener('click', toggleEmergencySection);
            document.getElementById('breathingBtn').addEventListener('click', startBreathingGuide);
            document.getElementById('motivationBtn').addEventListener('click', showMotivation);
            document.getElementById('distractionBtn').addEventListener('click', suggestDistraction);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            document.getElementById('addActivityBtn').addEventListener('click', addActivity);
            document.getElementById('saveJournalBtn').addEventListener('click', saveJournal);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importInput').click());
            document.getElementById('importInput').addEventListener('change', importData);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            
            // Ë®≠ÂÆö„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò
            document.getElementById('goalDays').addEventListener('change', (e) => {
                appData.goalDays = parseInt(e.target.value, 10);
                saveData();
            });
            document.getElementById('enableNotifications').addEventListener('change', (e) => {
                appData.notifications = e.target.checked;
                if (appData.notifications) {
                    requestNotificationPermission();
                }
                saveData();
            });

            // Enter„Ç≠„Éº„Åß„ÅÆÊ¥ªÂãïËøΩÂä†
            document.getElementById('addActivityInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addActivity();
            });
        }

        // „Çø„Éñ„Ç∑„Çπ„ÉÜ„É†
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
        }

        function showTab(tabId) {
            // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
            });
            
            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabId);
            });
            
            // ÁâπÂÆö„ÅÆ„Çø„Éñ„Åß„ÅÆËøΩÂä†Âá¶ÁêÜ
            if (tabId === 'analytics') {
                setTimeout(updateCharts, 100); // DOMÊõ¥Êñ∞Âæå„Å´„ÉÅ„É£„Éº„ÉàÊõ¥Êñ∞
            }
            if (tabId === 'journal') {
                loadTodayJournal();
                renderJournalHistory();
            }
            if (tabId === 'achievements') {
                renderAchievements();
            }
            if (tabId === 'activities') {
                renderActivities();
            }
        }

        // „É°„Ç§„É≥Êõ¥Êñ∞Èñ¢Êï∞
        function updateAll() {
            updateStats();
            updateLevel();
            renderAchievements();
            renderActivities();
            saveData();
        }

        // Áµ±Ë®àÊõ¥Êñ∞
        function updateStats() {
            const streak = getCurrentStreak();
            const longest = getLongestStreak();
            const total = appData.achievedDates.length;
            const rate = calculateSuccessRate();
            
            document.getElementById('currentStreak').textContent = streak;
            document.getElementById('longestStreak').textContent = longest;
            document.getElementById('totalDays').textContent = total;
            document.getElementById('successRate').textContent = rate;
        }

        // „É¨„Éô„É´Êõ¥Êñ∞
        function updateLevel() {
            const currentLevel = calculateLevel();
            const currentLevelData = levels[currentLevel - 1];
            // Ê¨°„ÅÆ„É¨„Éô„É´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®„ÅÆ„É¨„Éô„É´„ÅÆXP„ÇíÊúÄÂ§ßXP„Å®„Åô„Çã
            const nextLevelData = levels[currentLevel] || { level: currentLevel + 1, xp: appData.totalXP + 100 }; 
            
            const currentXP = appData.totalXP - currentLevelData.xp;
            const maxXP = nextLevelData.xp - currentLevelData.xp;
            const progress = Math.min((currentXP / maxXP) * 100, 100);
            
            document.getElementById('userLevel').textContent = currentLevel;
            document.getElementById('currentXP').textContent = currentXP;
            document.getElementById('maxXP').textContent = maxXP;
            document.getElementById('xpProgress').style.width = progress + '%';
            document.getElementById('levelTitle').textContent = currentLevelData.title;
        }

        // ‰ªäÊó•„ÅÆÊàêÂäü„Çí„Éû„Éº„ÇØ
        function markTodaySuccess() {
            const today = formatDate(new Date());
            if (!appData.achievedDates.includes(today)) {
                appData.achievedDates.push(today);
                appData.totalXP += 10; // ÁµåÈ®ìÂÄ§Áç≤Âæó
                appData.achievedDates.sort((a, b) => new Date(a) - new Date(b)); // Êó•‰ªò„Çí„ÇΩ„Éº„Éà

                // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ
                const oldLevel = calculateLevel();
                updateAll();
                const newLevel = calculateLevel();
                
                if (newLevel > oldLevel) {
                    showLevelUpMessage(newLevel);
                }
                
                showSuccessMessage();
                renderCalendar();
                checkAchievements();
                sendNotification('‚úÖ Á¶ÅÊ¨≤„ÉÅ„É£„É¨„É≥„Ç∏', '‰ªäÊó•„ÅÆÁ¶ÅÊ¨≤„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ');
            } else {
                showModal('‰ªäÊó•„ÅÆÈÅîÊàê', '‰ªäÊó•„ÅØÊó¢„Å´ÈÅîÊàêÊ∏à„Åø„Å®„Åó„Å¶Ë®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
            }
        }

        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showSuccessMessage() {
            const messages = [
                'üéâ Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ„Åù„ÅÆË™øÂ≠êÔºÅ',
                'üî• Á∂ôÁ∂ö„ÅØÂäõ„Å™„ÇäÔºÅ',
                '‚≠ê ‰ªäÊó•„ÇÇ„Çà„ÅèÈ†ëÂºµ„Å£„ÅüÔºÅ',
                'üí™ Âêõ„Å™„Çâ„Åß„Åç„ÇãÔºÅ',
                'üåü „Åæ„Åü‰∏ÄÊ≠©ÂâçÈÄ≤ÔºÅ',
                'üèÜ ÂÆåÁíß„Å†ÔºÅ',
                '‚ú® Ëá™ÂàÜ„ÇíË™á„Çä„Å´ÊÄù„Å£„Å¶ÔºÅ'
            ];
            
            const message = messages[Math.floor(Math.random() * messages.length)];
            const messageEl = document.getElementById('congratsMessage');
            messageEl.innerHTML = `<h2>${message}</h2><p>ÁµåÈ®ìÂÄ§ +10 Áç≤ÂæóÔºÅ</p>`;
            messageEl.style.display = 'block';
            messageEl.classList.add('fade-in');
            
            setTimeout(() => {
                messageEl.style.display = 'none';
                messageEl.classList.remove('fade-in');
            }, 3000);
        }

        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏
        function showLevelUpMessage(level) {
            const levelData = levels[level - 1];
            showModal('üéâ „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ', `„É¨„Éô„É´ ${level}: ${levelData.title}\n\n„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ`);
        }

        // Á∑äÊÄ•„Çµ„Éù„Éº„Éà
        function toggleEmergencySection() {
            const section = document.getElementById('emergencySection');
            section.classList.toggle('hidden');
        }

        function startBreathingGuide() {
            let count = 0;
            const breathingSteps = ['Âê∏„Å£„Å¶...', 'Ê≠¢„ÇÅ„Å¶...', 'Âêê„ÅÑ„Å¶...', 'Ê≠¢„ÇÅ„Å¶...'];
            const durations = [4000, 1000, 4000, 1000]; // „Éü„É™Áßí
            
            function nextStep() {
                if (count < 20) { // 5ÂõûÁπ∞„ÇäËøî„Åó
                    const stepIndex = count % 4;
                    showModal('ü´Å Ê∑±ÂëºÂê∏„Ç¨„Ç§„Éâ', `${breathingSteps[stepIndex]} (${Math.floor(count/4) + 1}/5)`);
                    setTimeout(nextStep, durations[stepIndex]);
                    count++;
                } else {
                    showModal('üåü Ê∑±ÂëºÂê∏ÂÆå‰∫ÜÔºÅ', 'ËêΩ„Å°ÁùÄ„Åç„Åæ„Åó„Åü„ÅãÔºü');
                }
            }
            
            showModal('ü´Å Ê∑±ÂëºÂê∏„Ç¨„Ç§„Éâ„ÇíÈñãÂßã„Åó„Åæ„Åô', 'ÊåáÁ§∫„Å´Âæì„Å£„Å¶ÂëºÂê∏„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            setTimeout(nextStep, 1500); // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´ÈñãÂßã
        }

        function showMotivation() {
            const motivations = [
                'üéØ „ÅÇ„Å™„Åü„ÅÆÁõÆÊ®ô„ÇíÊÄù„ÅÑÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ\n‰ªä„Åæ„ÅßÁ©ç„ÅøÈáç„Å≠„Å¶„Åç„ÅüÂä™Âäõ„ÇíÁÑ°ÈßÑ„Å´„Åó„Å™„ÅÑ„ÅßÔºÅ',
                'üí™ „Åì„ÅÆÁû¨Èñì„ÅÆË™òÊÉë„ÅØ‰∏ÄÊôÇÁöÑ„Åß„Åô„ÄÇ\nÂæå„ÅßÂøÖ„ÅöÂæåÊÇî„Åô„Çã„Åì„Å®„ÇíÁü•„Å£„Å¶„ÅÑ„Çã„ÅØ„Åö„Åß„Åô„ÄÇ',
                'üåü ‰ªäÊó•„Çí‰πó„ÇäÂàá„Çå„Å∞„ÄÅÊòéÊó•„ÅØ„ÇÇ„Å£„Å®Âº∑„Åè„Å™„Çå„Åæ„ÅôÔºÅ',
                'üèÜ „ÅÇ„Å™„Åü„ÅØÊó¢„Å´' + getCurrentStreak() + 'Êó•„ÇÇÁ∂ôÁ∂ö„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑË®òÈå≤„Åß„ÅôÔºÅ',
                'üî• „Åì„ÅÆÊåëÊà¶„ÇíÈÄö„Åó„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅØÊú¨ÂΩì„ÅÆÂº∑„Åï„ÇíÊâã„Å´ÂÖ•„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                '‚≠ê Êú™Êù•„ÅÆËá™ÂàÜ„Åå„ÅÇ„Å™„Åü„Å´ÊÑüË¨ù„Åô„ÇãÊó•„ÅåÊù•„Åæ„Åô„ÄÇ‰ªäÈ†ëÂºµ„Å£„Å¶ÔºÅ'
            ];
            
            const motivation = motivations[Math.floor(Math.random() * motivations.length)];
            showModal('üí™ „É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Ë£úÁµ¶', motivation);
        }

        function suggestDistraction() {
            if (appData.activities.length === 0) {
                showModal('‰ª£ÊõøÊ¥ªÂãï', '‰ª£ÊõøÊ¥ªÂãï„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                showTab('activities');
                return;
            }
            
            const activity = appData.activities[Math.floor(Math.random() * appData.activities.length)];
            showModal('üí° Ê∞óÂàÜËª¢Êèõ', `‰ªä„Åô„Åê„Åì„Çå„Çí„ÇÑ„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºö\n\n"${activity}"\n\n5ÂàÜ„Å†„Åë„Åß„ÇÇÂßã„ÇÅ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`);
        }

        // Êó•Ë®òÊ©üËÉΩ
        function loadTodayJournal() {
            const today = formatDate(new Date());
            const entry = appData.journal[today] || '';
            document.getElementById('journalEntry').value = entry;
        }

        function saveJournal() {
            const today = formatDate(new Date());
            const entry = document.getElementById('journalEntry').value.trim();
            
            if (entry) {
                appData.journal[today] = entry;
                saveData();
                showModal('üìî Êó•Ë®ò', 'Êó•Ë®ò„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                renderJournalHistory();
                checkAchievements(); // Êó•Ë®ò‰øùÂ≠òÊôÇ„Å´„ÇÇÂÆüÁ∏æ„ÉÅ„Çß„ÉÉ„ÇØ
            } else {
                showModal('üìî Êó•Ë®ò', 'Êó•Ë®ò„ÅåÁ©∫„Åß„Åô„ÄÇ‰Ωï„ÅãÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        function renderJournalHistory() {
            const history = document.getElementById('journalHistory');
            const entries = Object.entries(appData.journal)
                .sort(([a], [b]) => new Date(b) - new Date(a))
                .slice(0, 10); // ÊúÄÊñ∞10‰ª∂
            
            if (entries.length === 0) {
                history.innerHTML = '<p style="opacity: 0.6;">„Åæ„Å†Êó•Ë®ò„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            history.innerHTML = entries.map(([date, entry]) => `
                <div style="border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 1em; margin: 0.5em 0;">
                    <strong>${formatDateJapanese(parseDate(date))}</strong>
                    <p style="margin: 0.5em 0; opacity: 0.9;">${entry}</p>
                </div>
            `).join('');
        }

        // ‰ª£ÊõøÊ¥ªÂãï
        function addActivity() {
            const input = document.getElementById('addActivityInput');
            const activity = input.value.trim();
            
            if (activity && !appData.activities.includes(activity)) {
                appData.activities.push(activity);
                input.value = '';
                saveData();
                renderActivities();
                checkAchievements(); // Ê¥ªÂãïËøΩÂä†ÊôÇ„Å´„ÇÇÂÆüÁ∏æ„ÉÅ„Çß„ÉÉ„ÇØ
            } else if (!activity) {
                showModal('Ê¥ªÂãïËøΩÂä†', 'Ê¥ªÂãïÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } else {
                showModal('Ê¥ªÂãïËøΩÂä†', '„Åù„ÅÆÊ¥ªÂãï„ÅØÊó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
            }
        }

        function renderActivities() {
            const container = document.getElementById('activitiesList');
            
            if (appData.activities.length === 0) {
                container.innerHTML = '<p style="opacity: 0.6;">Ê¥ªÂãï„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
                return;
            }
            
            // „Ç∑„É£„ÉÉ„Éï„É´„Åó„Å¶Ë°®Á§∫
            const shuffled = [...appData.activities].sort(() => Math.random() - 0.5);
            
            container.innerHTML = shuffled.map((activity, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8em; margin: 0.5em 0; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <span>${activity}</span>
                    <button class="btn" style="padding: 0.3em 0.8em; font-size: 0.8em;" onclick="removeActivity('${activity}')">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        function removeActivity(activity) {
            showConfirm('Ê¥ªÂãï„ÅÆÂâäÈô§', `'${activity}' „ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`, () => {
                const index = appData.activities.indexOf(activity);
                if (index > -1) {
                    appData.activities.splice(index, 1);
                    saveData();
                    renderActivities();
                }
            });
        }

        // ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É†
        function checkAchievements() {
            const streak = getCurrentStreak();
            const longest = getLongestStreak();
            
            achievements.forEach(achievement => {
                if (!hasAchievement(achievement.id)) {
                    let unlocked = false;
                    
                    if (achievement.days && longest >= achievement.days) {
                        unlocked = true;
                    } else if (achievement.special === 'perfect_week' && checkPerfectWeek()) {
                        unlocked = true;
                    } else if (achievement.special === 'comeback' && checkComeback()) {
                        unlocked = true;
                    } else if (achievement.special === 'journal_count' && Object.keys(appData.journal).length >= achievement.count) {
                        unlocked = true;
                    } else if (achievement.special === 'activity_count' && appData.activities.length >= achievement.count) {
                        unlocked = true;
                    }
                    
                    if (unlocked) {
                        unlockAchievement(achievement.id);
                    }
                }
            });
        }

        function hasAchievement(id) {
            return appData.unlockedAchievements && appData.unlockedAchievements.includes(id);
        }

        function unlockAchievement(id) {
            if (!appData.unlockedAchievements) appData.unlockedAchievements = [];
            appData.unlockedAchievements.push(id);
            
            const achievement = achievements.find(a => a.id === id);
            appData.totalXP += 50; // ÂÆüÁ∏æ„Åß„Éú„Éº„Éä„ÇπXP
            
            setTimeout(() => {
                showModal('üèÜ ÂÆüÁ∏æËß£Èô§ÔºÅ', `${achievement.icon} ${achievement.title}\n${achievement.desc}\n\nÁµåÈ®ìÂÄ§ +50 Áç≤ÂæóÔºÅ`);
            }, 500);
            
            saveData();
            updateLevel();
        }

        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            
            grid.innerHTML = achievements.map(achievement => {
                const unlocked = hasAchievement(achievement.id);
                const progress = getAchievementProgress(achievement);
                
                return `
                    <div class="achievement ${unlocked ? 'unlocked' : ''}" title="${achievement.desc}${progress ? ' - ' + progress : ''}">
                        <div class="achievement-icon">${unlocked ? achievement.icon : 'üîí'}</div>
                        <div class="achievement-title">${achievement.title}</div>
                        ${progress ? `<div style="font-size: 0.7em; opacity: 0.8;">${progress}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function getAchievementProgress(achievement) {
            if (achievement.days) {
                const current = getLongestStreak();
                return current >= achievement.days ? 'ÈÅîÊàêÊ∏à„Åø' : `${current}/${achievement.days}`;
            } else if (achievement.special === 'journal_count') {
                const current = Object.keys(appData.journal).length;
                return current >= achievement.count ? 'ÈÅîÊàêÊ∏à„Åø' : `${current}/${achievement.count}`;
            } else if (achievement.special === 'activity_count') {
                const current = appData.activities.length;
                return current >= achievement.count ? 'ÈÅîÊàêÊ∏à„Åø' : `${current}/${achievement.count}`;
            }
            return '';
        }

        // „Ç´„É¨„É≥„ÉÄ„Éº
        function renderCalendar() {
            const firstDay = new Date(viewYear, viewMonth, 1);
            const lastDay = new Date(viewYear, viewMonth + 1, 0);
            const startDay = firstDay.getDay(); // 0:Êó•, 1:Êúà, ..., 6:Âúü
            
            document.getElementById('monthYear').textContent = `${viewYear}Âπ¥${viewMonth + 1}Êúà`;
            
            let html = '<tr><th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th><th>Êú®</th><th>Èáë</th><th>Âúü</th></tr>';
            
            let date = 1;
            for (let week = 0; week < 6; week++) {
                html += '<tr>';
                for (let day = 0; day < 7; day++) {
                    if (week === 0 && day < startDay) {
                        html += '<td></td>';
                    } else if (date > lastDay.getDate()) {
                        html += '<td></td>';
                    } else {
                        const currentDate = new Date(viewYear, viewMonth, date);
                        const dateKey = formatDate(currentDate);
                        const isToday = dateKey === formatDate(new Date());
                        const isAchieved = appData.achievedDates.includes(dateKey);
                        
                        let classes = [];
                        if (isToday) classes.push('today');
                        if (isAchieved) classes.push('achieved');
                        
                        html += `<td class="${classes.join(' ')}" onclick="toggleDate('${dateKey}')">${date}</td>`;
                        date++;
                    }
                }
                html += '</tr>';
                if (date > lastDay.getDate()) break;
            }
            
            document.getElementById('calendarTable').innerHTML = html;
        }

        function changeMonth(delta) {
            viewMonth += delta;
            if (viewMonth < 0) {
                viewYear--;
                viewMonth = 11;
            } else if (viewMonth > 11) {
                viewYear++;
                viewMonth = 0;
            }
            renderCalendar();
        }

        function toggleDate(dateKey) {
            // ‰ªäÊó•„ÅÆÊó•‰ªò‰ª•Â§ñ„ÅØ„Éà„Ç∞„É´ÂèØËÉΩ„Å´„Åô„Çã
            const today = formatDate(new Date());
            if (dateKey === today) {
                showModal('Êó•‰ªò„ÅÆÂ§âÊõ¥', '‰ªäÊó•„ÅÆÈÅîÊàêÁä∂Ê≥Å„ÅØ„Äå‰ªäÊó•ÈÅîÊàêÔºÅ„Äç„Éú„Çø„É≥„ÅßË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            showConfirm('Êó•‰ªò„ÅÆÂ§âÊõ¥', `${dateKey} „ÅÆÈÅîÊàêÁä∂Ê≥Å„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åô„ÅãÔºü`, () => {
                const index = appData.achievedDates.indexOf(dateKey);
                if (index >= 0) {
                    appData.achievedDates.splice(index, 1);
                    appData.totalXP = Math.max(0, appData.totalXP - 10);
                } else {
                    appData.achievedDates.push(dateKey);
                    appData.totalXP += 10;
                }
                
                appData.achievedDates.sort((a, b) => new Date(a) - new Date(b)); // „ÇΩ„Éº„Éà
                updateAll();
                renderCalendar();
                checkAchievements();
            });
        }

        // „ÉÅ„É£„Éº„ÉàÊ©üËÉΩ
        function initCharts() {
            // ÊúàÂà•ÊàêÂäüÁéá„ÉÅ„É£„Éº„Éà
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ÊúàÂà•ÊàêÂäüÁéá (%)',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: getChartTextColor() } }
                    },
                    scales: {
                        x: { ticks: { color: getChartTextColor() }, grid: { color: getChartGridColor() } },
                        y: { 
                            ticks: { color: getChartTextColor(), callback: function(value) { return value + '%'; } }, 
                            grid: { color: getChartGridColor() },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            // ÊõúÊó•Âà•ÊàêÂäüÁéá„ÉÅ„É£„Éº„Éà
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            charts.weekly = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'],
                    datasets: [{
                        label: 'ÊõúÊó•Âà•ÊàêÂäüÁéá (%)',
                        data: [],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)', // Êó•
                            'rgba(54, 162, 235, 0.6)', // Êúà
                            'rgba(255, 206, 86, 0.6)', // ÁÅ´
                            'rgba(75, 192, 192, 0.6)', // Ê∞¥
                            'rgba(153, 102, 255, 0.6)', // Êú®
                            'rgba(255, 159, 64, 0.6)', // Èáë
                            'rgba(199, 199, 199, 0.6)'  // Âúü
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(199, 199, 199, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: getChartTextColor() } }
                    },
                    scales: {
                        x: { ticks: { color: getChartTextColor() }, grid: { color: getChartGridColor() } },
                        y: { 
                            ticks: { color: getChartTextColor(), callback: function(value) { return value + '%'; } }, 
                            grid: { color: getChartGridColor() },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            updateCharts(); // ÂàùÊúü„Éá„Éº„Çø„Åß„ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞
        }

        function updateCharts() {
            // ÊúàÂà•ÊàêÂäüÁéá„Éá„Éº„Çø„ÅÆË®àÁÆó
            const monthlyData = calculateMonthlySuccessRates();
            charts.monthly.data.labels = monthlyData.labels;
            charts.monthly.data.datasets[0].data = monthlyData.data;
            charts.monthly.update();

            // ÊõúÊó•Âà•ÊàêÂäüÁéá„Éá„Éº„Çø„ÅÆË®àÁÆó
            const weeklyData = calculateWeeklySuccessRates();
            charts.weekly.data.datasets[0].data = weeklyData;
            charts.weekly.update();

            // „ÉÅ„É£„Éº„Éà„ÅÆ„ÉÜ„Éº„Éû„ÇíÈÅ©Áî®
            charts.monthly.options.plugins.legend.labels.color = getChartTextColor();
            charts.monthly.options.scales.x.ticks.color = getChartTextColor();
            charts.monthly.options.scales.y.ticks.color = getChartTextColor();
            charts.monthly.options.scales.x.grid.color = getChartGridColor();
            charts.monthly.options.scales.y.grid.color = getChartGridColor();
            charts.monthly.update();

            charts.weekly.options.plugins.legend.labels.color = getChartTextColor();
            charts.weekly.options.scales.x.ticks.color = getChartTextColor();
            charts.weekly.options.scales.y.ticks.color = getChartTextColor();
            charts.weekly.options.scales.x.grid.color = getChartGridColor();
            charts.weekly.options.scales.y.grid.color = getChartGridColor();
            charts.weekly.update();
        }

        function getChartTextColor() {
            return appData.theme === 'dark' ? '#ddd' : '#333';
        }

        function getChartGridColor() {
            return appData.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        }

        // „Éò„É´„Éë„ÉºÈñ¢Êï∞
        function formatDate(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function parseDate(dateString) {
            const [y, m, d] = dateString.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function formatDateJapanese(date) {
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const dayOfWeek = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][date.getDay()];
            return `${y}Âπ¥${m}Êúà${d}Êó•(${dayOfWeek})`;
        }

        function getDaysBetween(d1, d2) {
            const date1 = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
            const date2 = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
            const diffTime = Math.abs(date2 - date1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // „Çπ„Éà„É™„Éº„ÇØË®àÁÆó
        function getCurrentStreak() {
            if (appData.achievedDates.length === 0) return 0;

            let streak = 0;
            let currentDate = new Date();
            let lastAchievedDate = parseDate(appData.achievedDates[appData.achievedDates.length - 1]);

            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÅåÈÅîÊàêÊ∏à„Åø„Åß„Å™„ÅÑ„ÄÅ„Åã„Å§Êò®Êó•„ÇÇÈÅîÊàêÊ∏à„Åø„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Çπ„Éà„É™„Éº„ÇØ„ÅØ0
            if (formatDate(currentDate) !== formatDate(lastAchievedDate) && getDaysBetween(currentDate, lastAchievedDate) > 1) {
                return 0;
            }

            // ‰ªäÊó•„ÅåÈÅîÊàêÊ∏à„Åø„ÄÅ„Åæ„Åü„ÅØÊò®Êó•„ÅåÈÅîÊàêÊ∏à„Åø„ÅÆÂ†¥Âêà„ÄÅ„Åù„Åì„Åã„ÇâÈÅ°„Å£„Å¶„Çπ„Éà„É™„Éº„ÇØ„ÇíË®àÁÆó
            let tempDate = new Date(lastAchievedDate);
            for (let i = appData.achievedDates.length - 1; i >= 0; i--) {
                const date = parseDate(appData.achievedDates[i]);
                if (formatDate(date) === formatDate(tempDate)) {
                    streak++;
                    tempDate.setDate(tempDate.getDate() - 1); // ÂâçÊó•„Å∏
                } else if (getDaysBetween(date, tempDate) === 0) { // Âêå„ÅòÊó•‰ªò„ÅåË§áÊï∞„ÅÇ„Å£„ÅüÂ†¥ÂêàÔºà„ÅÇ„Çä„Åà„Å™„ÅÑ„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ
                    continue;
                } else {
                    break; // ÈÄ£Á∂ö„ÅåÈÄîÂàá„Çå„Åü
                }
            }
            return streak;
        }

        function getLongestStreak() {
            if (appData.achievedDates.length === 0) return 0;

            let maxStreak = 0;
            let currentStreak = 0;
            
            // achievedDates„ÅØ„ÇΩ„Éº„Éà„Åï„Çå„Å¶„ÅÑ„ÇãÂâçÊèê
            for (let i = 0; i < appData.achievedDates.length; i++) {
                if (i === 0) {
                    currentStreak = 1;
                } else {
                    const prevDate = parseDate(appData.achievedDates[i - 1]);
                    const currentDate = parseDate(appData.achievedDates[i]);
                    if (getDaysBetween(prevDate, currentDate) === 1) {
                        currentStreak++;
                    } else if (getDaysBetween(prevDate, currentDate) === 0) { // Âêå„ÅòÊó•‰ªò„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                        continue;
                    } else {
                        maxStreak = Math.max(maxStreak, currentStreak);
                        currentStreak = 1;
                    }
                }
                maxStreak = Math.max(maxStreak, currentStreak); // „É´„Éº„Éó„ÅÆÊúÄÂæå„Å´Êõ¥Êñ∞
            }
            return maxStreak;
        }

        function calculateSuccessRate() {
            if (appData.achievedDates.length === 0) return 0;

            // „Ç¢„Éó„É™ÈñãÂßãÊó•„ÇíÁâπÂÆö
            const firstDate = parseDate(appData.achievedDates[0]);
            const today = new Date();
            const totalPossibleDays = getDaysBetween(firstDate, today) + 1; // ÈñãÂßãÊó•„Åã„Çâ‰ªäÊó•„Åæ„Åß„ÅÆÁ∑èÊó•Êï∞

            return ((appData.achievedDates.length / totalPossibleDays) * 100).toFixed(1);
        }

        function calculateLevel() {
            let currentLevel = 1;
            for (let i = 0; i < levels.length; i++) {
                if (appData.totalXP >= levels[i].xp) {
                    currentLevel = levels[i].level;
                } else {
                    break;
                }
            }
            return currentLevel;
        }

        // ÂÆüÁ∏æ„ÅÆÁâπÊÆäÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
        function checkPerfectWeek() {
            if (appData.achievedDates.length < 7) return false;

            const sortedDates = [...appData.achievedDates].map(d => new Date(d)).sort((a, b) => b - a); // ÊúÄÊñ∞È†Ü„Å´„ÇΩ„Éº„Éà

            for (let i = 0; i <= sortedDates.length - 7; i++) {
                let isPerfect = true;
                for (let j = 0; j < 7; j++) {
                    const dateToCheck = new Date(sortedDates[i]);
                    dateToCheck.setDate(dateToCheck.getDate() - j); // ÈÅ°„Çã
                    if (!appData.achievedDates.includes(formatDate(dateToCheck))) {
                        isPerfect = false;
                        break;
                    }
                }
                if (isPerfect) return true;
            }
            return false;
        }

        function checkComeback() {
            // Â§±ÊïóÂæåÂæ©Ê¥ª„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÅØ„ÄÅ‰æã„Åà„Å∞„Äå„Çπ„Éà„É™„Éº„ÇØ„Åå0„Å´„Å™„Å£„ÅüÂæå„ÄÅÂÜçÂ∫¶1Êó•ÈÅîÊàê„Åó„Åü„Äç„Å™„Å©„ÅßÂà§ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ
            // „Åì„Åì„Åß„ÅØ„ÄÅÁõ¥Ëøë„ÅÆÈÅîÊàêÊó•„ÅåÈÅéÂéª„Å´„Çπ„Éà„É™„Éº„ÇØ„ÅåÈÄîÂàá„Çå„ÅüÂæå„Å´Ë®òÈå≤„Åï„Çå„ÅüÂ†¥Âêà„ÇíÁ∞°ÊòìÁöÑ„Å´Âà§ÂÆö„Åó„Åæ„Åô„ÄÇ
            // „Çà„ÇäÂé≥ÂØÜ„Å´„Åô„Çã„Å´„ÅØ„ÄÅÈÅéÂéª„ÅÆ„Çπ„Éà„É™„Éº„ÇØÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
            if (appData.achievedDates.length < 2) return false;

            const sortedDates = [...appData.achievedDates].map(d => new Date(d)).sort((a, b) => a - b); // Âè§„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà

            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = sortedDates[i - 1];
                const currentDate = sortedDates[i];
                // 2Êó•‰ª•‰∏äÈñì„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Åü„Çâ„ÄÅ„Çπ„Éà„É™„Éº„ÇØ„ÅåÈÄîÂàá„Çå„Åü„Å®„Åø„Å™„Åô
                if (getDaysBetween(prevDate, currentDate) > 1) {
                    return true; // ÈÄîÂàá„Çå„ÅüÂæå„Å´ÂÜçÈñã„Åó„Åü
                }
            }
            return false;
        }


        function calculateMonthlySuccessRates() {
            const monthlyStats = {}; // { 'YYYY-MM': { totalDays: 0, achievedDays: 0 } }

            // „Éá„Éº„Çø„ÅÆ„ÅÇ„ÇãÊúÄÂàù„ÅÆÊúà„Åã„ÇâÁèæÂú®„ÅÆÊúà„Åæ„Åß„ÇíÂØæË±°
            let startDate = appData.achievedDates.length > 0 ? parseDate(appData.achievedDates[0]) : new Date();
            let endDate = new Date();

            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

            while (currentMonth <= endDate) {
                const yearMonth = `${currentMonth.getFullYear()}-${(currentMonth.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyStats[yearMonth] = { totalDays: 0, achievedDays: 0 };
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }

            // ÂêÑÊúà„ÅÆÁ∑èÊó•Êï∞„Å®ÈÅîÊàêÊó•Êï∞„ÇíË®àÁÆó
            for (const dateStr of appData.achievedDates) {
                const date = parseDate(dateStr);
                const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                if (monthlyStats[yearMonth]) {
                    monthlyStats[yearMonth].achievedDays++;
                }
            }

            // ÂêÑÊúà„ÅÆÁ∑èÊó•Êï∞„ÇíË®àÁÆó
            for (const monthKey in monthlyStats) {
                const [year, month] = monthKey.split('-').map(Number);
                const daysInMonth = new Date(year, month, 0).getDate();
                monthlyStats[monthKey].totalDays = daysInMonth;
            }

            // ÁèæÂú®„ÅÆÊúà„ÅØ‰ªäÊó•„Åæ„Åß„ÅÆÊó•Êï∞„ÅßË®àÁÆó
            const currentYearMonth = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
            if (monthlyStats[currentYearMonth]) {
                monthlyStats[currentYearMonth].totalDays = endDate.getDate(); // ‰ªäÊúà„ÅØ‰ªäÊó•„Åæ„Åß„ÅÆÊó•Êï∞
            }

            const labels = [];
            const data = [];

            // Êúà„Çí„ÇΩ„Éº„Éà„Åó„Å¶„ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„Çí‰ΩúÊàê
            Object.keys(monthlyStats).sort().forEach(monthKey => {
                labels.push(monthKey);
                const stats = monthlyStats[monthKey];
                const rate = stats.totalDays > 0 ? ((stats.achievedDays / stats.totalDays) * 100).toFixed(1) : 0;
                data.push(rate);
            });

            return { labels, data };
        }

        function calculateWeeklySuccessRates() {
            const weeklyStats = new Array(7).fill(0).map(() => ({ total: 0, achieved: 0 })); // Êó•-Âúü

            for (const dateStr of appData.achievedDates) {
                const date = parseDate(dateStr);
                const dayOfWeek = date.getDay(); // 0:Êó•, 1:Êúà, ..., 6:Âúü
                weeklyStats[dayOfWeek].achieved++;
            }

            // ÂÖ®ÊúüÈñì„ÅÆÂêÑÊõúÊó•„ÅÆÁ∑èÊó•Êï∞„ÇíË®àÁÆó
            if (appData.achievedDates.length > 0) {
                const firstDate = parseDate(appData.achievedDates[0]);
                const today = new Date();
                let tempDate = new Date(firstDate);

                while (tempDate <= today) {
                    const dayOfWeek = tempDate.getDay();
                    weeklyStats[dayOfWeek].total++;
                    tempDate.setDate(tempDate.getDate() + 1);
                }
            } else { // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅÈÅéÂéª7Êó•Èñì„ÅÆÊõúÊó•„Çí„Ç´„Ç¶„É≥„Éà
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const tempDate = new Date(today);
                    tempDate.setDate(today.getDate() - i);
                    const dayOfWeek = tempDate.getDay();
                    weeklyStats[dayOfWeek].total++;
                }
            }


            const rates = weeklyStats.map(stats => {
                return stats.total > 0 ? ((stats.achieved / stats.total) * 100).toFixed(1) : 0;
            });

            return rates;
        }


        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
        function toggleTheme() {
            appData.theme = appData.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveData();
            updateCharts(); // „ÉÅ„É£„Éº„Éà„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàËâ≤„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅ„Å´ÂÜçÊèèÁîª
        }

        function applyTheme() {
            document.body.classList.toggle('light-mode', appData.theme === 'light');
            document.getElementById('themeToggle').textContent = appData.theme === 'dark' ? 'üåì „ÉÜ„Éº„ÉûÂàáÊõø' : '‚òÄÔ∏è „ÉÜ„Éº„ÉûÂàáÊõø';
        }

        // ‰ªäÊó•„ÅÆÂêçË®ÄË°®Á§∫
        function showDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const quoteIndex = dayOfYear % quotes.length;
            const quote = quotes[quoteIndex];
            document.getElementById('quoteText').textContent = `"${quote.text}"`;
            document.getElementById('quoteAuthor').textContent = `- ${quote.author}`;
        }

        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà/„Ç§„É≥„Éù„Éº„Éà
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'abstinence_challenge_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showModal('„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà', '„Éá„Éº„Çø„Åå„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Å®„Éû„Éº„Ç∏„Åô„Çã„Åã„ÄÅÂÆåÂÖ®„Å´ÁΩÆ„ÅçÊèõ„Åà„Çã„ÅãÈÅ∏ÊäûËÇ¢„Çí‰∏é„Åà„Çã„Åì„Å®„ÇÇÂèØËÉΩ
                    showConfirm('„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà', 'ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åü„Éá„Éº„Çø„Åß‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü', () => {
                        appData = { ...appData, ...importedData }; // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„Åß‰∏äÊõ∏„Åç
                        appData.achievedDates.sort((a, b) => new Date(a) - new Date(b)); // Êó•‰ªò„Çí„ÇΩ„Éº„Éà
                        saveData();
                        init(); // „Ç¢„Éó„É™„ÇíÂÜçÂàùÊúüÂåñ„Åó„Å¶UI„ÇíÊõ¥Êñ∞
                        showModal('„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà', '„Éá„Éº„Çø„ÅåÊ≠£Â∏∏„Å´„Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    });
                } catch (error) {
                    showModal('„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº', 'JSON„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´„ÅåÁ†¥Êêç„Åó„Å¶„ÅÑ„Çã„Åã„ÄÅÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    console.error('„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                }
            };
            reader.readAsText(file);
        }

        // ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà
        function resetAll() {
            showConfirm('„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà', 'ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ', () => {
                localStorage.removeItem('enhancedAbstinenceData');
                appData = {
                    achievedDates: [],
                    totalXP: 0,
                    level: 1,
                    journal: {},
                    activities: [
                        '30ÂàÜÈÅãÂãï„Åô„Çã', 'Êú¨„Çí20„Éö„Éº„Ç∏Ë™≠„ÇÄ', 'ÁûëÊÉ≥„Åô„Çã', 'Êï£Ê≠©„Å´Âá∫„Çã', 'ÂèãÈÅî„Å´ÈÄ£Áµ°',
                        '„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„Éñ„Å™‰ΩúÊ•≠', 'ÈÉ®Â±ã„ÇíÊï¥ÁêÜ', 'Êñ∞„Åó„ÅÑ„Çπ„Ç≠„É´Â≠¶Áøí', 'ÊñôÁêÜ„Çí„Åô„Çã', 'Èü≥Ê•Ω„ÇíËÅ¥„Åè'
                    ],
                    theme: 'dark',
                    goalDays: 30,
                    notifications: false,
                    streakProtections: 3,
                    unlockedAchievements: []
                };
                init();
                showModal('„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà', 'ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            });
        }

        // „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´Èñ¢Êï∞
        function showModal(title, message, callback = null) {
            const modalOverlay = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // „Éú„Çø„É≥„Çí„ÇØ„É™„Ç¢

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.classList.add('btn');
            okButton.onclick = () => {
                modalOverlay.classList.remove('visible');
                if (callback) callback();
            };
            modalButtons.appendChild(okButton);

            modalOverlay.classList.add('visible');
        }

        function showConfirm(title, message, onConfirm, onCancel = null) {
            const modalOverlay = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // „Éú„Çø„É≥„Çí„ÇØ„É™„Ç¢

            const confirmButton = document.createElement('button');
            confirmButton.textContent = '„ÅØ„ÅÑ';
            confirmButton.classList.add('btn', 'primary');
            confirmButton.onclick = () => {
                modalOverlay.classList.remove('visible');
                if (onConfirm) onConfirm();
            };
            modalButtons.appendChild(confirmButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = '„ÅÑ„ÅÑ„Åà';
            cancelButton.classList.add('btn');
            cancelButton.onclick = () => {
                modalOverlay.classList.remove('visible');
                if (onCancel) onCancel();
            };
            modalButtons.appendChild(cancelButton);

            modalOverlay.classList.add('visible');
        }

        // ÈÄöÁü•Ê©üËÉΩ
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showModal('ÈÄöÁü•', '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈÄöÁü•„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            if (Notification.permission === "granted") {
                console.log("ÈÄöÁü•„ÅØÊó¢„Å´Ë®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showModal('ÈÄöÁü•', 'ÈÄöÁü•„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ');
                        appData.notifications = true;
                        saveData();
                    } else {
                        showModal('ÈÄöÁü•', 'ÈÄöÁü•„ÅØÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„Åã„Çâ„ÅÑ„Å§„Åß„ÇÇÊúâÂäπ„Å´„Åß„Åç„Åæ„Åô„ÄÇ');
                        appData.notifications = false;
                        document.getElementById('enableNotifications').checked = false;
                        saveData();
                    }
                });
            } else {
                showModal('ÈÄöÁü•', 'ÈÄöÁü•„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åã„ÇâË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                appData.notifications = false;
                document.getElementById('enableNotifications').checked = false;
                saveData();
            }
        }

        function sendNotification(title, body) {
            if (appData.notifications && Notification.permission === "granted") {
                new Notification(title, { body: body, icon: 'https://placehold.co/64x64/FF6B6B/FFFFFF?text=üî•' });
            }
        }

        // „Ç¢„Éó„É™Ëµ∑Âãï
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
